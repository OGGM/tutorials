
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>A look into the new mass balance calibration in OGGM v1.6 &#8212; OGGM tutorials</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-106829797-2"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'UA-106829797-2');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'UA-106829797-2');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/tutorials/massbalance_calibration';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Plotting the OGGM surface mass-balance, the ELA and AAR" href="plot_mass_balance.html" />
    <link rel="prev" title="Mass balance" href="../../book/massbalance.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../welcome.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="OGGM tutorials - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="OGGM tutorials - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../welcome.html">
                    OGGM tutorials
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../book/10minutes.html">10 minutes tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../10minutes/preprocessed_directories.html">10 minutes to… a preprocessed directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10minutes/run_with_gcm.html">10 minutes to… a glacier change projection with GCM data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10minutes/machine_learning.html">10 minutes to… OGGM as an accelerator for machine learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10minutes/dynamical_spinup.html">10 minutes to… understand the new dynamical spinup in OGGM v1.6</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../book/workflow.html">OGGM workflow</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="working_with_rgi.html">Working with the RGI files</a></li>
<li class="toctree-l2"><a class="reference internal" href="store_and_compress_glacierdirs.html">Storing glacier directories for later use</a></li>
<li class="toctree-l2"><a class="reference internal" href="deal_with_errors.html">Dealing with errors after a run</a></li>
<li class="toctree-l2"><a class="reference internal" href="elevation_bands_vs_centerlines.html">Differences between the “elevation band” and “centerline” flowlines</a></li>
<li class="toctree-l2"><a class="reference internal" href="full_prepro_workflow.html">What’s in my preprocessed directories with centerlines? A full OGGM workflow, step by step</a></li>
<li class="toctree-l2"><a class="reference internal" href="rebuilding_the_prepro_gdirs.html">Step-by-Step guide to rebuilding the preprocessed directories from scratch</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../../book/massbalance.html">Mass balance</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">A look into the new mass balance calibration in OGGM v1.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_mass_balance.html">Plotting the OGGM surface mass-balance, the ELA and AAR</a></li>

<li class="toctree-l2"><a class="reference internal" href="massbalance_global_params.html">Global distribution of the mass-balance model parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="massbalance_perturbation.html">Mass balance parameter perturbation experiments with OGGM</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../book/hydro.html">Hydrological output</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="hydrological_output.html">Hydrological mass-balance output</a></li>
<li class="toctree-l2"><a class="reference external" href="https://oggm.org/oggm-edu-notebooks/oggm-edu/glacier_water_resources.html">Glaciers as water resources (OGGM-Edu part 1 - idealized)</a></li>
<li class="toctree-l2"><a class="reference external" href="https://oggm.org/oggm-edu-notebooks/oggm-edu/glacier_water_resources_projections.html">Glaciers as water resources (OGGM-Edu part 2 - projections)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../book/dynamics.html">Dynamical runs</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="run_with_a_spinup_and_gcm_data.html">Run with a long spinup and GCM data</a></li>
<li class="toctree-l2"><a class="reference internal" href="dynamical_spinup.html">Dynamic spinup and dynamic <em>melt_f</em> calibration for past simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="numeric_solvers.html">Understand the difference between the ice dynamic solvers in OGGM</a></li>

</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../book/thickness.html">Ice thickness</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="inversion.html">Ice thickness inversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="observed_thickness_with_dynamic_spinup.html">Dynamic model initialization using observed thickness data</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../book/shop.html">OGGM shop and additional data</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="oggm_shop.html">OGGM-Shop and Glacier Directories in OGGM</a></li>
<li class="toctree-l2"><a class="reference internal" href="use_your_own_inventory.html">Using your our own glacier inventory with OGGM</a></li>
<li class="toctree-l2"><a class="reference internal" href="ingest_gridded_data_on_flowlines.html">Ingest gridded products such as ice velocity into OGGM</a></li>
<li class="toctree-l2"><a class="reference internal" href="dem_sources.html">Create local topography maps from different DEM sources with OGGM</a></li>
<li class="toctree-l2"><a class="reference internal" href="rgitopo_rgi6.html">Compare different DEMs for individual glaciers: RGI-TOPO for RGI v6.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="rgitopo_rgi7.html">RGI-TOPO for RGI 7.0</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../book/visualisation.html">Visualisation and post-processing</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="distribute_flowline.html">Display glacier area and thickness changes on a grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="where_are_the_flowlines.html">OGGM flowlines: where are they?</a></li>
<li class="toctree-l2"><a class="reference internal" href="centerlines_to_shape.html">Compute smoother centerlines for shapefile output</a></li>
<li class="toctree-l2"><a class="reference internal" href="preprocessing_errors.html">Error analysis of the global pre-processing workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="merge_gcm_runs_and_visualize.html">Merge, analyse and visualize OGGM GCM runs</a></li>
<li class="toctree-l2"><a class="reference internal" href="holoviz_intro.html">Small overview of HoloViz capability of data exploration</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../book/construction.html">Tutorials in (re-)construction</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../construction/inversion_with_frontal_ablation.html">Ice thickness inversion with frontal ablation: a case study</a></li>
<li class="toctree-l2"><a class="reference internal" href="../construction/kcalving_parameterization.html">The Oerlemans &amp; Nick frontal ablation parameterization in OGGM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../construction/merging_glaciers.html">Merging glaciers for past climate simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../construction/area_length_filter.html">Filter the glacier length and area time series</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/OGGM/tutorials/master?urlpath=lab/tree/./notebooks/tutorials/massbalance_calibration.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://hub.oggm.org/hub/user-redirect/git-pull?repo=https%3A//github.com/OGGM/tutorials&urlpath=lab/tree/tutorials/./notebooks/tutorials/massbalance_calibration.ipynb&branch=master" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onJupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/OGGM/tutorials" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/OGGM/tutorials/edit/master/./notebooks/tutorials/massbalance_calibration.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/OGGM/tutorials/issues/new?title=Issue%20on%20page%20%2Fnotebooks/tutorials/massbalance_calibration.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/tutorials/massbalance_calibration.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>A look into the new mass balance calibration in OGGM v1.6</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">Set-up</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrated-mass-balance-parameters-in-oggm-v1-6-pre-processed-directories">Calibrated mass balance parameters in OGGM v1.6 pre-processed directories</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-new-flexible-calibration-scheme-in-oggm">The new flexible calibration scheme in OGGM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrate-on-direct-glaciological-in-situ-mb-observations">Calibrate on direct glaciological in-situ MB observations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-errors-and-including-your-own-mass-balance-observations">Dealing with errors and including your own mass-balance observations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overparameteristion-or-the-magic-choice-of-the-best-calibration-option">Overparameteristion or the magic choice of the best calibration option:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#back-to-where-we-started-how-did-we-calibrate-the-default-pre-processed-directories-in-oggm-1-6">Back to where we started: how did we calibrate the default pre-processed directories in OGGM 1.6?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#first-step-data-informed-precipitation-factor">First step: data informed precipitation factor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#second-step-data-informed-temperature-bias">Second step: data informed temperature bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#third-step-local-calibration-using-the-data-informed-precipitation-factor-and-temperature-bias-as-first-guesses">Third step: local calibration using the data informed precipitation factor and temperature bias as first guesses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-look-into-the-global-parameter-distributions">A look into the global parameter distributions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#take-home-points">Take home points</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-s-next">What’s next?</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="a-look-into-the-new-mass-balance-calibration-in-oggm-v1-6">
<h1>A look into the new mass balance calibration in OGGM v1.6<a class="headerlink" href="#a-look-into-the-new-mass-balance-calibration-in-oggm-v1-6" title="Link to this heading">#</a></h1>
<p>The default mass-balance (MB) model of OGGM is a very standard <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0022169403002579">temperature index melt model</a>.</p>
<p>In versions before 1.6, OGGM had a complex calibration procedure which originated from the times where we had only observations from a few hundred glaciers. We used them to calibrate the model and then a so-called infamous <em>tstar</em> (infamous in very niche circles of first- and second-gen OGGMers) which was interpolated to glaciers without observations (see the <a class="reference external" href="https://www.the-cryosphere.net/6/1295/2012/tc-6-1295-2012.html">original publication</a>). This method was very powerful but, as new observational datasets emerged, we can now calibrate on a glacier-per-glacier basis. With the new era of geodetic observations, OGGM uses the average geodetic observations from Jan 2000–Jan 2020 of <a class="reference external" href="https://www.nature.com/articles/s41586-021-03436-z">Hugonnet al. 2021</a>, that are now available for almost every glacier world-wide.</p>
<p>Pre-processed directories from OGGM (from the Bremen server) have been calibrated for you, based on a specific climate dataset (W5E5) and our own dedicated calibration strategy. But, what if you want to use another climate dataset? Or another reference dataset?</p>
<p>In this notebook, we will:</p>
<ul class="simple">
<li><p>introduce the new flexible calibration method available to all users since OGGM v1.6: <a class="reference external" href="https://docs.oggm.org/en/latest/generated/oggm.tasks.mb_calibration_from_scalar_mb.html">mb_calibration_from_scalar_mb</a></p></li>
<li><p>show how users can apply it (and extend it) for their own workflow</p></li>
<li><p>explain how we used it to calibrate the OGGM pre-processed directories</p></li>
</ul>
<section id="set-up">
<h2>Set-up<a class="headerlink" href="#set-up" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">oggm</span>
<span class="kn">from</span> <span class="nn">oggm</span> <span class="kn">import</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">graphics</span>
<span class="kn">from</span> <span class="nn">oggm.core</span> <span class="kn">import</span> <span class="n">massbalance</span>
<span class="kn">from</span> <span class="nn">oggm.core.massbalance</span> <span class="kn">import</span> <span class="n">mb_calibration_from_scalar_mb</span><span class="p">,</span> <span class="n">mb_calibration_from_geodetic_mb</span><span class="p">,</span> <span class="n">mb_calibration_from_wgms_mb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">logging_level</span><span class="o">=</span><span class="s1">&#39;WARNING&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">PATHS</span><span class="p">[</span><span class="s1">&#39;working_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(</span><span class="n">dirname</span><span class="o">=</span><span class="s1">&#39;OGGM-calib-mb&#39;</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;border&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-04-25 13:33:02: oggm.cfg: Reading default parameters from the OGGM `params.cfg` configuration file.
2024-04-25 13:33:02: oggm.cfg: Multiprocessing switched OFF according to the parameter file.
2024-04-25 13:33:02: oggm.cfg: Multiprocessing: using all available processors (N=4)
2024-04-25 13:33:03: oggm.cfg: PARAMS[&#39;border&#39;] changed from `80` to `10`.
</pre></div>
</div>
</div>
</div>
<p>We start from two well known glaciers in the Austrian Alps, Kesselwandferner and Hintereisferner. But you can also choose any other other glacier, e.g. from <a class="reference external" href="https://github.com/OGGM/oggm-sample-data/blob/master/wgms/rgi_wgms_links_20220112.csv">this list</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we start from preprocessing level 3</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;https://cluster.klima.uni-bremen.de/~oggm/gdirs/oggm_v1.6/L3-L5_files/2023.3/elev_bands/W5E5/&#39;</span>
<span class="n">gdirs</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">init_glacier_directories</span><span class="p">([</span><span class="s1">&#39;RGI60-11.00787&#39;</span><span class="p">,</span>  <span class="s1">&#39;RGI60-11.00897&#39;</span><span class="p">],</span> <span class="n">from_prepro_level</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">prepro_base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-04-25 13:33:04: oggm.workflow: init_glacier_directories from prepro level 3 on 2 glaciers.
2024-04-25 13:33:04: oggm.workflow: Execute entity tasks [gdir_from_prepro] on 2 glaciers
</pre></div>
</div>
</div>
</div>
<p>The two glaciers are neighbors but have very different geometries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">plot_googlemap</span><span class="p">(</span><span class="n">gdirs</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">gdirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rgi_id</span> <span class="o">+</span> <span class="s1">&#39; &amp; &#39;</span> <span class="o">+</span> <span class="n">gdirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ed2f102db242045243d89192fe0fc7f4c750708902c93366075aef71ee92d57f.png" src="../../_images/ed2f102db242045243d89192fe0fc7f4c750708902c93366075aef71ee92d57f.png" />
</div>
</div>
</section>
<section id="calibrated-mass-balance-parameters-in-oggm-v1-6-pre-processed-directories">
<h2>Calibrated mass balance parameters in OGGM v1.6 pre-processed directories<a class="headerlink" href="#calibrated-mass-balance-parameters-in-oggm-v1-6-pre-processed-directories" title="Link to this heading">#</a></h2>
<p>We just downloaded the data. Let’s have a look at the climate data we used and the calibrated parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pick each glacier</span>
<span class="n">gdir_kwf</span> <span class="o">=</span> <span class="n">gdirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gdir_hef</span> <span class="o">=</span> <span class="n">gdirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">get_climate_info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;,
 &#39;baseline_yr_0&#39;: 1901,
 &#39;baseline_yr_1&#39;: 2019,
 &#39;baseline_climate_ref_hgt&#39;: 2252.0,
 &#39;baseline_climate_ref_pix_lon&#39;: 10.75,
 &#39;baseline_climate_ref_pix_lat&#39;: 46.75}
</pre></div>
</div>
</div>
</div>
<p>This is called the “baseline climate” in OGGM and is necessary to calibrate the model against observations. Ideally, the baseline climate should be real observations as perfect as possible, but in reality this is not the case. Often, gridded climate datasets have biases - we need to take this into accound during our calibration. Let’s have a look at the mass balance parameters for both glaciers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rgi_id&#39;: &#39;RGI60-11.00897&#39;,
 &#39;bias&#39;: 0,
 &#39;melt_f&#39;: 5.0,
 &#39;prcp_fac&#39;: 3.532785225968441,
 &#39;temp_bias&#39;: 1.7583130779353044,
 &#39;reference_mb&#39;: -1100.3,
 &#39;reference_mb_err&#39;: 171.8,
 &#39;reference_period&#39;: &#39;2000-01-01_2020-01-01&#39;,
 &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
  &#39;temp_all_solid&#39;: 0.0,
  &#39;temp_all_liq&#39;: 2.0,
  &#39;temp_melt&#39;: -1.0},
 &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_kwf</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rgi_id&#39;: &#39;RGI60-11.00787&#39;,
 &#39;bias&#39;: 0,
 &#39;melt_f&#39;: 5.0,
 &#39;prcp_fac&#39;: 2.9632765179490517,
 &#39;temp_bias&#39;: 1.7583130779353044,
 &#39;reference_mb&#39;: -514.8000000000001,
 &#39;reference_mb_err&#39;: 136.3,
 &#39;reference_period&#39;: &#39;2000-01-01_2020-01-01&#39;,
 &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
  &#39;temp_all_solid&#39;: 0.0,
  &#39;temp_all_liq&#39;: 2.0,
  &#39;temp_melt&#39;: -1.0},
 &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}
</pre></div>
</div>
</div>
</div>
<p>We will explain later what all these mean. Lets focus on these for now: <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>, and <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> which have been calibrated with <code class="docutils literal notranslate"><span class="pre">reference_mb</span></code> over the reference period <code class="docutils literal notranslate"><span class="pre">reference_period</span></code>.</p>
<p>Per default the <a class="reference external" href="https://www.nature.com/articles/s41586-021-03436-z">Hugonnet et al. (2021)</a> average geodetic observation is used over the entire time period Jan 2000 to Jan 2020 to calibrate the MB model parameter(s) for every single glacier.</p>
<p>For our two neighboring example glaciers, that share the same climate gridpoint, the same pre-calibrated <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> and the same <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is used. The <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> is slighly different, hence in that example, changing the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> within the narrow range of <span class="math notranslate nohighlight">\([0.8,1.2]\)</span> was sufficient to match the MB model to the observations.</p>
<p>Note that the two glaciers are in the same climate (from the forcing data) but are very different in size, orientation and geometry. So, at least one of the MB model parameters is different (here the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>) and also the observed MB values vary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">gdir</span> <span class="ow">in</span> <span class="n">gdirs</span><span class="p">:</span>
    <span class="n">mbmod</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir</span><span class="p">)</span>
    <span class="n">mean_mb</span> <span class="o">=</span> <span class="n">mbmod</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">fls</span><span class="o">=</span><span class="n">gdir</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;inversion_flowlines&#39;</span><span class="p">),</span>
                                               <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gdir</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;: average MB 2000-2020 = </span><span class="si">{</span><span class="n">mean_mb</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> kg m-2, &#39;</span><span class="p">,</span>
          <span class="sa">f</span><span class="s2">&quot;prcp_fac: </span><span class="si">{</span><span class="n">gdir</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RGI60-11.00787 : average MB 2000-2020 = -514.8 kg m-2,  prcp_fac: 2.96
RGI60-11.00897 : average MB 2000-2020 = -1100.3 kg m-2,  prcp_fac: 3.53
</pre></div>
</div>
</div>
</div>
<p><em>Kesselwandferner has a less negative MB than its neighbor, probably because it is smaller in size and spans less altitude. To simplify things, we will now focus just on one glacier (Hintereisferner), but you can repeat it of course with other glaciers.</em></p>
<div class="alert alert-info">
    <b>
        How are these parameters calibrated by OGGM? How can I calibrate them for my use case? <br>
        These are the questions we want to address in the rest of the notebook. We  will change the three MB model parameters (melt_f, temp_bias and prcp_fac) and see their influence on the calibration, to allow users to make an informed decision on how to calibrate them for their purpose. Then we will go back to the calibration method used by OGGM for the preprocessed directories.
    </b>
</div><p>Note alst that there are some global MB parameters (<code class="docutils literal notranslate"><span class="pre">mb_global_params</span></code>), which we assume to be the same globally for every glacier:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;mb_global_params&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;temp_default_gradient&#39;: -0.0065,
 &#39;temp_all_solid&#39;: 0.0,
 &#39;temp_all_liq&#39;: 2.0,
 &#39;temp_melt&#39;: -1.0}
</pre></div>
</div>
</div>
</div>
<p>These global MB parameter values were found to represent best the in-situ observations during a cross-validation for glaciers with additional observations. Of course, they could also be changed for different glaciers, but this would need even more data to justify the differences! The influence of using a different temperature lapse rate gradient to the default -0.0065 K/km are analysed in <a class="reference external" href="https://doi.org/10.1017/aog.2023.57">Schuster et al., 2023</a>.</p>
<p>First, let’s check if the OGGM calibration worked at all</p>
<ul class="simple">
<li><p>we will get first the average modelled MB:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">get_inversion_flowline_hw</span><span class="p">()</span>
<span class="n">mb_geod</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="c1"># Note, if you change cfg.PARAMS[&#39;geodetic_mb_period&#39;], you need to change the years here as well!</span>
<span class="n">mbdf</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_geod</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">mbdf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mod_mb   -1100.3
dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>then get the observed geodetic MB that we calibrated our mass-balance to:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reference MB: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;reference_mb&#39;</span><span class="p">])</span><span class="o">+</span> <span class="s1">&#39; kg m-2&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reference MB uncertainties: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;reference_mb_err&#39;</span><span class="p">])</span><span class="o">+</span> <span class="s1">&#39; kg m-2&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reference MB time period: &#39;</span> <span class="o">+</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;reference_period&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>reference MB: -1100.3 kg m-2
reference MB uncertainties: 171.8 kg m-2
reference MB time period: 2000-01-01_2020-01-01
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We calibrated on the entire 20-yr time period, because then the observational uncertainties are smallest.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># this tests if the two parameters are very similar:</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;reference_mb&#39;</span><span class="p">],</span> <span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Perfect! Our MB model reproduces the average observed MB, so the calibrated worked!</p>
</section>
<section id="the-new-flexible-calibration-scheme-in-oggm">
<h2>The new flexible calibration scheme in OGGM<a class="headerlink" href="#the-new-flexible-calibration-scheme-in-oggm" title="Link to this heading">#</a></h2>
<p>We have now used the option that is applied in the preprocessed directories. However, there are many other calibration options. We will show you some options, but you could also invent your own!</p>
<p><strong>Calibrate <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, fixed <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">temp_bìas</span></code></strong></p>
<p>For example, let’s calibrate the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> to match the same observations as before (i.e., average geodetic observation) and fix the other parameters. We will use the more general function <a class="reference external" href="https://docs.oggm.org/en/latest/generated/oggm.tasks.mb_calibration_from_scalar_mb.html">mb_calibration_from_scalar_mb</a> which is most flexible. However, it requires you to give manually the observed MB on which you want to calibrate:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># if you use the default calibration data from Hugonnet et al., 2021, </span>
<span class="c1"># we can get the geodetic data from any glacier from here:</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_geodetic_mb_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">]</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">ref_mb_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># dmdtda: in meters water-equivalent per year -&gt; we convert to kg m-2 yr-1</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;dmdtda&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">ref_mb</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1100.3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s calibrate the melt_f (this is the default option in mb_calibration_from_scalar_mb)</span>
<span class="c1"># overwrite_gdir has to be set to True,</span>
<span class="c1"># because we want to overwrite the old calibration</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span>
                              <span class="n">ref_mb</span> <span class="o">=</span> <span class="n">ref_mb</span><span class="p">,</span> 
                              <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                              <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

<span class="n">mb_melt_f</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_melt_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_melt_f</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s read the new calibrated MB model parameter for the glacier:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rgi_id&#39;: &#39;RGI60-11.00897&#39;,
 &#39;bias&#39;: 0,
 &#39;melt_f&#39;: 9.06088881579363,
 &#39;prcp_fac&#39;: 3.357136316271367,
 &#39;temp_bias&#39;: 0,
 &#39;reference_mb&#39;: -1100.3,
 &#39;reference_mb_err&#39;: None,
 &#39;reference_period&#39;: &#39;2000-01-01_2020-01-01&#39;,
 &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
  &#39;temp_all_solid&#39;: 0.0,
  &#39;temp_all_liq&#39;: 2.0,
  &#39;temp_melt&#39;: -1.0},
 &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}
</pre></div>
</div>
</div>
</div>
<p>Only <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is used to calibrate the MB model. <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> was chosen depending on the average winter precipitation (explained below) and <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> is 0.</p>
<p><strong>Calibrate <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>, fixed <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">melt_f</span></code></strong></p>
<p>We will now instead fix the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> and the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>, and use the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> as free variable for calibration. For that we overwrite the default value of <code class="docutils literal notranslate"><span class="pre">calibrate_param1</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s calibrate on the temp_bias instead</span>
<span class="c1"># overwrite_gdir has to be set to True,</span>
<span class="c1"># because we want to overwrite the old calibration</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span>
                              <span class="n">ref_mb</span> <span class="o">=</span> <span class="n">ref_mb</span><span class="p">,</span> 
                              <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                              <span class="n">calibrate_param1</span><span class="o">=</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">,</span>
                              <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">mb_temp_b</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_temp_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_temp_b</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mb_params</span> <span class="o">=</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)</span>
<span class="n">mb_params</span><span class="p">[</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">],</span> <span class="n">mb_params</span><span class="p">[</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">],</span> <span class="n">mb_params</span><span class="p">[</span><span class="s1">&#39;melt_f&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1.6621867397806107, 3.357136316271367, 5.0)
</pre></div>
</div>
</div>
</div>
<p>Here we used the median <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> (i.e., 5 kg m-2 day-1 K-1) and the same <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> as in the previous option, but changed <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> until the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> is matched. As the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is lower than in the previous calibration option, we need to have a positive <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> to get to the same average MB (i.e., <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code>).</p>
<p><strong>Calibrate <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>, fixed <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> and <code class="docutils literal notranslate"><span class="pre">melt_f</span></code></strong></p>
<p>Similarly, we can also just calibrate on the precipitation factor (<code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s calibrate on the prcp_fac instead</span>
<span class="c1"># overwrite_gdir has to be set to True,</span>
<span class="c1"># because we want to overwrite the old calibration</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span>
                              <span class="n">ref_mb</span> <span class="o">=</span> <span class="n">ref_mb</span><span class="p">,</span> 
                              <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                              <span class="n">calibrate_param1</span><span class="o">=</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">,</span>
                              <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">mb_prcp_fac</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_prcp_fac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_prcp_fac</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="n">mb_params</span> <span class="o">=</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)</span>
<span class="n">mb_params</span><span class="p">[</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">],</span> <span class="n">mb_params</span><span class="p">[</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">],</span> <span class="n">mb_params</span><span class="p">[</span><span class="s1">&#39;melt_f&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0, 1.0160354839620402, 5.0)
</pre></div>
</div>
</div>
</div>
<p>We chose two glaciers that actually have also in-situ observations available.
We will get the in-situ observations like that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;in_situ_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">get_ref_mb_data</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">][</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">]</span>
<span class="c1"># if we want to compare the average to the average geodetic MB, we need to have all years available</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;in_situ_mb&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot how well we match the interannual observations for the different calibration options:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;in_situ_mb&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;in-situ observations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">in_situ_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span><span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;modelled mass-balance via preprocessed directories</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">mod_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_melt_f&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;modelled mass-balance via calibrating melt_f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">mod_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_temp_b&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;modelled mass-balance via calibrating temp_bias</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">mod_mb_temp_b</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_prcp_fac&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;modelled mass-balance via calibrating prcp_fac</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">mod_mb_prcp_fac</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;specific mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/acb70b2849dedb343988c2ded447ecf4e966cdef29f22cfabf705256f72c109d.png" src="../../_images/acb70b2849dedb343988c2ded447ecf4e966cdef29f22cfabf705256f72c109d.png" />
</div>
</div>
<p>For this glacier, over the same time period (here 2000-2020), the average MB is quite similar between the geodetic and in-situ observation and could even be explained by the fact that the in-situ observations are in hydrological years (starting in October of the previous year) and the geodetic observations are in calendar years. If you repeat the analysis for other glaciers with in-situ observations over that time period, you might see larger discrepancies.</p>
<p>You can also see, that there are differences in the annual MB between the calibration options and the in-situ observations. We will analyse these differences more systematically later!</p>
</section>
<section id="calibrate-on-direct-glaciological-in-situ-mb-observations">
<h2>Calibrate on direct glaciological in-situ MB observations<a class="headerlink" href="#calibrate-on-direct-glaciological-in-situ-mb-observations" title="Link to this heading">#</a></h2>
<p>Ok, but actually you might trust the in-situ observations much more than the geodetic observation. So if you are only interested in glaciers with these in-situ observations, you can also use the in-situ observations for calibration. This might allow you also to calibrate over a longer time period and to use additional informations (such as the interannual MB variability, seasonal MB, …). However, bare in mind that there are often gaps in the in-situ MB time series and make sure that you calibrate to the same modelled time period!</p>
<p>Attention: For the Hintereisferner glacier with an almost 70-year long time series, the assumption that we make, i.e., that the area does not change over the time period, gets more problematic. So think twice before repeating this at home!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mb_calibration_from_wgms_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rgi_id&#39;: &#39;RGI60-11.00897&#39;,
 &#39;bias&#39;: 0,
 &#39;melt_f&#39;: 11.27883598160852,
 &#39;prcp_fac&#39;: 3.357136316271367,
 &#39;temp_bias&#39;: 0,
 &#39;reference_mb&#39;: -648.223880597015,
 &#39;reference_mb_err&#39;: None,
 &#39;reference_period&#39;: &#39;custom&#39;,
 &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
  &#39;temp_all_solid&#39;: 0.0,
  &#39;temp_all_liq&#39;: 2.0,
  &#39;temp_melt&#39;: -1.0},
 &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mb_calibration_from_wgms_mb</span></code> is a short-cut function that uses internally <code class="docutils literal notranslate"><span class="pre">mb_calibration_from_scalar_mb</span></code>,
but applies directly the average annual in-situ MB observations from the WGMS. Per default, the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is calibrated, and <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> are fixed. You can get the observations like that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbdf_in_situ</span> <span class="o">=</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">get_ref_mb_data</span><span class="p">()</span>
<span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;ref_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">]</span>
<span class="c1"># check that every year between the beginning and the end has MB observations </span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">ref_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mb_in_situ_obs</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_in_situ_obs</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;ref_mb&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;in-situ observations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average: </span><span class="si">{</span><span class="n">ref_mb</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span><span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;modelled mass-balance</span><span class="se">\n</span><span class="s1">via calibrating melt_f</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average: </span><span class="si">{</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">mod_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;specific mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6ef3aaff6a880c62301e99a53b76767ee363a5d4fc19223e21966eb86f637c23.png" src="../../_images/6ef3aaff6a880c62301e99a53b76767ee363a5d4fc19223e21966eb86f637c23.png" />
</div>
</div>
<p>The average MB over the entire time period is matched as we calibrate to it. However, the interannual mass-balance variability is different. How well the modelled annual mass-balance time series matches the observations can be for example assessed by looking at the correlation between modelled and observed annual MB:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbdf_in_situ</span><span class="p">[[</span><span class="s1">&#39;ref_mb&#39;</span><span class="p">,</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.806883065989496
</pre></div>
</div>
</div>
</div>
<p>or by looking into the standard deviation of interannual MB variability, where we see a much larger variability for the modelled MB:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbdf_in_situ</span><span class="p">[[</span><span class="s1">&#39;ref_mb&#39;</span><span class="p">,</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ref_mb     624.538759
mod_mb    1276.246655
dtype: float64
</pre></div>
</div>
</div>
</div>
<section id="dealing-with-errors-and-including-your-own-mass-balance-observations">
<h3>Dealing with errors and including your own mass-balance observations<a class="headerlink" href="#dealing-with-errors-and-including-your-own-mass-balance-observations" title="Link to this heading">#</a></h3>
<p>Let’s look at another glacier, now in Central Asia, for example the Golubin glacier:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_gol</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">init_glacier_directories</span><span class="p">([</span><span class="s1">&#39;RGI60-13.11609&#39;</span><span class="p">],</span> <span class="n">from_prepro_level</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">prepro_base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">tasks</span><span class="o">.</span><span class="n">process_climate_data</span><span class="p">(</span><span class="n">gdir_gol</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">plot_googlemap</span><span class="p">([</span><span class="n">gdir_gol</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-04-25 13:33:11: oggm.workflow: init_glacier_directories from prepro level 3 on 1 glaciers.
2024-04-25 13:33:11: oggm.workflow: Execute entity tasks [gdir_from_prepro] on 1 glaciers
</pre></div>
</div>
<img alt="../../_images/d62703505fdf967fbfdc69921cecc3213d1a0fd4e4c99a31464dbe9b779e6b6b.png" src="../../_images/d62703505fdf967fbfdc69921cecc3213d1a0fd4e4c99a31464dbe9b779e6b6b.png" />
</div>
</div>
<p>Let’s calibrate that glacier by only changing the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, default in <code class="docutils literal notranslate"><span class="pre">mb_calibration_from_scalar_mb</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first need to get the MB observations again</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_geodetic_mb_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdir_gol</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">]</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">ref_mb_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># dmdtda: in meters water-equivalent per year -&gt; we convert to kg m-2 yr-1</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;dmdtda&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">ref_mb</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-255.9
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note that this will create an error!</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_gol</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">ref_period</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-04-25 13:33:23: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-13.11609: RGI60-13.11609: ref mb not matched. Try to set calibrate_param2.
</pre></div>
</div>
</div>
</div>
<p>We got a <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> that says that the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> is not matched and that we should set <code class="docutils literal notranslate"><span class="pre">calibrate_param2</span></code>. What happened?</p>
<p>Well, no <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> parameter could be found in the given ranges to reproduce the given calibration data (<code class="docutils literal notranslate"><span class="pre">ref_mb</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># What are the current minimum and maximum ranges of the melt factor (unit: kg m-2 day-1 K-1)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;melt_f_min&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;melt_f_max&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1.5, 17.0)
</pre></div>
</div>
</div>
</div>
<p>If we believe that our observations are true, maybe the climate or the processes represented by the MB model are erroneous.</p>
<p>What can we do to still match the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code>? We can either change the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> ranges by setting other values to the parameters above or we can allow that another MB model parameter is changed (i.e., <code class="docutils literal notranslate"><span class="pre">calibrate_param2</span></code>). This is basically very similar to the three-step-calibration
first introduced in <a class="reference external" href="https://doi.org/10.3389/feart.2015.00054">Huss &amp; Hock 2015</a>, but here you can choose your parameter ranges and parameter order yourself.</p>
<p>To reduce these MB model calibration errors, you can first change the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, fix it at the lower or upper limit, and then change the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allowing another parameter to change is done by defining calibrate_param2</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_gol</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> 
                              <span class="n">write_to_gdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">ref_period</span> <span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span> 
                              <span class="n">calibrate_param1</span><span class="o">=</span><span class="s1">&#39;melt_f&#39;</span><span class="p">,</span> 
                              <span class="n">calibrate_param2</span><span class="o">=</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rgi_id&#39;: &#39;RGI60-13.11609&#39;,
 &#39;bias&#39;: 0,
 &#39;melt_f&#39;: 1.5,
 &#39;prcp_fac&#39;: 3.7686569086250965,
 &#39;temp_bias&#39;: -0.5558387442516765,
 &#39;reference_mb&#39;: -255.9,
 &#39;reference_mb_err&#39;: None,
 &#39;reference_period&#39;: &#39;2000-01-01_2020-01-01&#39;,
 &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
  &#39;temp_all_solid&#39;: 0.0,
  &#39;temp_all_liq&#39;: 2.0,
  &#39;temp_melt&#39;: -1.0},
 &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is at the minimum value and temperature was corrected to more negative values to allow for the relatively weak negative MB.</p>
<p><strong>Use your own or fake MB observations for calibration</strong></p>
<p>In the same way, you can also use your own MB observations or fake data to calibrate the MB model. We use here as an example, an unrealistically high positive MB for the Hintereisferner over a 10-year time period. To allow the calibration to happen, we need again to set <code class="docutils literal notranslate"><span class="pre">calibrate_param2</span></code>! Here we will use the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> as second parameter for a change:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_period</span> <span class="o">=</span> <span class="s1">&#39;2000-01-01_2010-01-01&#39;</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># Let&#39;s use an unrealistically positive  mass-balance</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span>
                              <span class="n">ref_period</span><span class="o">=</span><span class="n">ref_period</span><span class="p">,</span> 
                              <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                              <span class="n">calibrate_param2</span><span class="o">=</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mb_new</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="c1"># ok, we actually matched the new ref_mb over the 10-yr period</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">mb_new</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2010</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="c1"># Let&#39;s look at the calibrated parameters</span>
<span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rgi_id&#39;: &#39;RGI60-11.00897&#39;,
 &#39;bias&#39;: 0,
 &#39;melt_f&#39;: 1.5,
 &#39;prcp_fac&#39;: 4.217210907878396,
 &#39;temp_bias&#39;: 0,
 &#39;reference_mb&#39;: 2000,
 &#39;reference_mb_err&#39;: None,
 &#39;reference_period&#39;: &#39;2000-01-01_2010-01-01&#39;,
 &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
  &#39;temp_all_solid&#39;: 0.0,
  &#39;temp_all_liq&#39;: 2.0,
  &#39;temp_melt&#39;: -1.0},
 &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}
</pre></div>
</div>
</div>
</div>
<p>Ok, in that case, the climate was too warm to allow for such a positive MB. Even the smallest <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> did not allow for such a positive MB. Therefore, the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> was increased to allow that more (solid) precipitation can occur.</p>
<p>However, also the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> has a limited range:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;prcp_fac_min&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;prcp_fac_max&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.1, 10.0)
</pre></div>
</div>
</div>
</div>
<p>So, if we increase the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> even further, we might even need a third free parameter (i.e., we need to set <code class="docutils literal notranslate"><span class="pre">calibrate_param3</span></code>).
Let’s try it out, by using now the same order as in <a class="reference external" href="https://doi.org/10.3389/feart.2015.00054">Huss &amp; Hock (2015)</a> (but different allowed parameter changes that also depend on the chosen climate…):</p>
<p>That means, we match the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> by</p>
<ul class="simple">
<li><p>first trying to adapt <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>,</p></li>
<li><p>then <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>,</p></li>
<li><p>and finally <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_mb</span> <span class="o">=</span> <span class="mi">6000</span> <span class="c1"># if you replace it with 8000, no combination of parameters can be found for that glacier</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span><span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span>
                              <span class="n">ref_period</span><span class="o">=</span><span class="n">ref_period</span><span class="p">,</span>
                              <span class="n">calibrate_param1</span><span class="o">=</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">,</span>
                              <span class="n">calibrate_param2</span><span class="o">=</span><span class="s1">&#39;melt_f&#39;</span><span class="p">,</span>
                              <span class="n">calibrate_param3</span><span class="o">=</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">,</span>
                              <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rgi_id&#39;: &#39;RGI60-11.00897&#39;,
 &#39;bias&#39;: 0,
 &#39;melt_f&#39;: 1.5,
 &#39;prcp_fac&#39;: 10.0,
 &#39;temp_bias&#39;: -0.8132605320838412,
 &#39;reference_mb&#39;: 6000,
 &#39;reference_mb_err&#39;: None,
 &#39;reference_period&#39;: &#39;2000-01-01_2010-01-01&#39;,
 &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
  &#39;temp_all_solid&#39;: 0.0,
  &#39;temp_all_liq&#39;: 2.0,
  &#39;temp_melt&#39;: -1.0},
 &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}
</pre></div>
</div>
</div>
</div>
<p>In that case, the minimum <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> and the maximum <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> are applied. The <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> is set to a negative value as this results in more solid precipitation. If you increased the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> even further, the method will not find any combination as the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> also has a limited
range. If you really want to match the observation, then you would need to change the parameter ranges.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;temp_bias_min&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;temp_bias_max&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-15.0, 15.0)
</pre></div>
</div>
</div>
</div>
<p>Check out the docstring for more information about the options by uncommenting the line below!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mb_calibration_from_scalar_mb?</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="overparameteristion-or-the-magic-choice-of-the-best-calibration-option">
<h2>Overparameteristion or the magic choice of the best calibration option:<a class="headerlink" href="#overparameteristion-or-the-magic-choice-of-the-best-calibration-option" title="Link to this heading">#</a></h2>
<p>We found already some combinations that equally well match the average MB over a given time period. As we only use only one observation per glacier (i.e., per default the average geodetic MB from 2000-2020), but have up to three free MB model parameters, the MB model is overparameterised. That means, there are in theory an infinite amount of calibration options possible that equally well match the one obervation. Let’s look a bit more systematically into that:</p>
<p>We will use a range of different <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and then calibrate the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> accordingly to always match to the default average MB (<code class="docutils literal notranslate"><span class="pre">ref_mb</span></code>) over the reference period (<code class="docutils literal notranslate"><span class="pre">ref_period</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s go back to the Hintereisferner glacier and get again the MB observations:</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_geodetic_mb_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">]</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">ref_mb_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;dmdtda&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calibrate the melt_f and annual MB </span>
<span class="c1"># Create a dataframe with precip factor going from 0.1 to 0.5 in 0.3 steps</span>
<span class="n">pd_prcp_fac_sens</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">))</span>
<span class="c1"># Calibrate the melt factor for each of these</span>
<span class="n">spec_mb_prcp_fac_sens_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">prcp_fac</span> <span class="ow">in</span> <span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">calib_param</span> <span class="o">=</span> <span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> 
                                                <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> 
                                                <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                                                <span class="n">prcp_fac</span><span class="o">=</span><span class="n">prcp_fac</span><span class="p">,</span> 
                                                <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Fill the dataframe with the calibrated parameters</span>
    <span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="s1">&#39;melt_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calib_param</span><span class="p">[</span><span class="s1">&#39;melt_f&#39;</span><span class="p">]</span>
     
    <span class="c1"># Check the modelled massbalance</span>
    <span class="n">mb_prcp_fac_sens</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
    <span class="c1"># ok, we actually matched the new ref_mb</span>
    <span class="n">annual_mb</span> <span class="o">=</span> <span class="n">mb_prcp_fac_sens</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">spec_mb_prcp_fac_sens_dict</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">]</span> <span class="o">=</span> <span class="n">annual_mb</span>
    <span class="c1"># let&#39;s also check how well the interannual MB variability is matched</span>
    <span class="c1"># by comparing the standard deviation of the annual MB to the observed one</span>
    <span class="n">std_quot_annual_mb</span> <span class="o">=</span> <span class="n">annual_mb</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">,</span> <span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="s1">&#39;std_quot_annual_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_quot_annual_mb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s get some nice colors visualising more precipitation</span>
<span class="n">colors_prcp_fac</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis_r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">10</span><span class="p">::</span><span class="mi">10</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">prcp_fac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="s1">&#39;melt_f&#39;</span><span class="p">],</span>
             <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors_prcp_fac</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;melt_f (kg m$^{-2}$ day$^{-1}$ K$^{-1}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c931448e45287fa4795659c26f4dc92b9a8047047a56007471a368673e6420fe.png" src="../../_images/c931448e45287fa4795659c26f4dc92b9a8047047a56007471a368673e6420fe.png" />
</div>
</div>
<p>All these combinations match the average <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> equally. The larger the chosen <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>, the larger needs to be the calibrated <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> when matching to the same average MB.</p>
<p>What is the influence on the chosen parameter combination on other estimates than the average MB?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">prcp_fac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
             <span class="n">spec_mb_prcp_fac_sens_dict</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="n">colors_prcp_fac</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prcp_fac</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
         <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">][</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">],</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed in-situ&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Annual mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;prcp_fac:&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/fce4a63ed82068a21fd7d01dd0022b4bc6b61df3e995e86b9fc126adc298bd4f.png" src="../../_images/fce4a63ed82068a21fd7d01dd0022b4bc6b61df3e995e86b9fc126adc298bd4f.png" />
</div>
</div>
<p>The larger the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, the larger is the interannual MB variability. For glaciers with in-situ observations, we can find a combination of <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> that has a similar interannnual MB variability than the observations. For example, you can choose a MB model parameter combination where the standard deviation quotient of the annual the modelled and observed MB is near to 1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condi</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_prcp_fac_sens</span><span class="p">[</span><span class="s1">&#39;std_quot_annual_mb&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pd_prcp_fac_sens</span><span class="p">[</span><span class="s1">&#39;std_quot_annual_mb&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">pd_prcp_fac_sens</span><span class="p">[</span><span class="n">condi</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>melt_f</th>
      <th>std_quot_annual_mb</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1.6</th>
      <td>6.012949</td>
      <td>0.952705</td>
    </tr>
    <tr>
      <th>1.9</th>
      <td>6.533331</td>
      <td>1.052461</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For the Hintereisferner glacier, the best MB model combination to match the interannual MB variability would be for a <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> between 1.6 and 1.9 and a <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> between 6 and 6.5 (more in <a class="reference external" href="https://doi.org/10.1017/aog.2023.57">Schuster et al., 2023</a>).</p>
<p><strong>We can also fix the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>, and change the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> and <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> instead:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">melt_f_dict_tb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">spec_mb_temp_b_sens_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">temp_bias</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="c1"># for too negative temp_bias, no melt_f is found that matches the observations. We would need to </span>
    <span class="c1"># change the prcp_fac , but here we will just look</span>
    <span class="c1"># at those combinations where calibration works with a fixed prcp_fac. </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">calib_param</span> <span class="o">=</span> <span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                                                    <span class="n">temp_bias</span><span class="o">=</span><span class="n">temp_bias</span><span class="p">,</span> <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">melt_f_dict_tb</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">]</span> <span class="o">=</span> <span class="n">calib_param</span><span class="p">[</span><span class="s1">&#39;melt_f&#39;</span><span class="p">]</span>
        <span class="n">mb_temp_b_sens</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
        <span class="c1"># ok, we actually matched the new ref_mb</span>
        <span class="n">spec_mb_temp_b_sens_dict</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_temp_b_sens</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span> <span class="c1">#, &#39;RGI60-11.00897: ref mb not matched. Try to set calibrate_param2&#39;</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-04-25 13:33:24: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:24: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:24: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:24: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:24: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:24: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:24: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:24: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s get a nice colormap centered at temp_bias=0</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">5.01</span><span class="p">)</span>
<span class="n">colors_temp_bias</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">temp_bias</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">melt_f_dict_tb</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">,</span> <span class="n">melt_f_dict_tb</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="n">colors_temp_bias</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">)))</span> 
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;melt_f (kg m$^{-2}$ day$^{-1}$ K$^{-1}$)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;temp_bias (°C)&#39;</span><span class="p">);</span>


<span class="k">for</span> <span class="n">temp_bias</span> <span class="ow">in</span> <span class="n">melt_f_dict_tb</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
             <span class="n">spec_mb_temp_b_sens_dict</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="n">colors_temp_bias</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">)),</span>
             <span class="n">label</span><span class="o">=</span><span class="n">temp_bias</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">][</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed in-situ&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Annual mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;temp_bias:&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b3f95037ec2d4b8892e7e04d4edb17a56f32c9822de2a2a1b5fce65aecb89692.png" src="../../_images/b3f95037ec2d4b8892e7e04d4edb17a56f32c9822de2a2a1b5fce65aecb89692.png" />
</div>
</div>
<p>A lower <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is needed if a positive <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> is applied… and with that the interannual MB variability gets smaller.</p>
<p><strong>Or we change <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>, and fix the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code></strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pf_temp_b_dict_tb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">spec_mb_pf_temp_b_sens_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">temp_bias</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="c1"># for too negative temp_bias, no prcp_fac is found that matches the observations. We would need to </span>
    <span class="c1"># change the melt_f , but here we will just look</span>
    <span class="c1"># at those combinations where calibration works with a fixed melt_f. </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">calib_param</span> <span class="o">=</span> <span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> <span class="n">calibrate_param1</span><span class="o">=</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">,</span>
                                                    <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                                                    <span class="n">temp_bias</span><span class="o">=</span><span class="n">temp_bias</span><span class="p">,</span> <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pf_temp_b_dict_tb</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">]</span> <span class="o">=</span> <span class="n">calib_param</span><span class="p">[</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">]</span>
        <span class="n">mb_pf_temp_b_sens</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
        <span class="c1"># ok, we actually matched the new ref_mb</span>
        <span class="n">spec_mb_pf_temp_b_sens_dict</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_pf_temp_b_sens</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span> <span class="c1">#, &#39;RGI60-11.00897: ref mb not matched. Try to set calibrate_param2&#39;</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-04-25 13:33:25: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:25: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:25: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:25: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:26: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:26: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:26: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:26: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
2024-04-25 13:33:26: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-11.00897: RGI60-11.00897: ref mb not matched. Try to set calibrate_param2.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s get another centered colormap at temp_bias=0</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">5.01</span><span class="p">)</span>
<span class="n">colors_temp_bias</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Spectral_r&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">temp_bias</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pf_temp_b_dict_tb</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">,</span> <span class="n">pf_temp_b_dict_tb</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="n">colors_temp_bias</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">)))</span> 
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;temp_bias (°C)&#39;</span><span class="p">);</span>


<span class="k">for</span> <span class="n">temp_bias</span> <span class="ow">in</span> <span class="n">pf_temp_b_dict_tb</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
             <span class="n">spec_mb_pf_temp_b_sens_dict</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="n">colors_temp_bias</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">)),</span>
             <span class="n">label</span><span class="o">=</span><span class="n">temp_bias</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">][</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed in-situ&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Annual mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;temp_bias:&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f772e75b3ff659c896a4873b39b6e313eedb9f1014d2cf9956802ce955ad88a4.png" src="../../_images/f772e75b3ff659c896a4873b39b6e313eedb9f1014d2cf9956802ce955ad88a4.png" />
</div>
</div>
<p>A larger <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> needs a larger <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> … and with that the interannual MB variability gets larger.</p>
<p>The parameter combination choice or calibration option also influences the modelled seasonal MB or elevation-dependent MB over the calibration period. Additionally, volume and runoff are influenced by the model parameter choice. If you are further interested in that, you can have a look into <a class="reference external" href="https://doi.org/10.1017/aog.2023.57">Schuster et al., 2023</a>, which analyses the “Glacier projections sensitivity to temperature-index model choices and calibration strategies”.</p>
<p>Using prior knowledge on the MB model parameters by a Bayesian calibration scheme is a good option to constrain the parameter ranges. Like that you can also directly include the MB observation uncertainties and quantify the parameter uncertainties. You can read about that in <a class="reference external" href="https://doi.org/10.1017/jog.2019.91">Rounce et al., 2020</a>!</p>
<p>We are working on including a Bayesian calibration framework into OGGM by using the calibration procedure explained below as prior estimates.</p>
</section>
<section id="back-to-where-we-started-how-did-we-calibrate-the-default-pre-processed-directories-in-oggm-1-6">
<h2>Back to where we started: how did we calibrate the default pre-processed directories in OGGM 1.6?<a class="headerlink" href="#back-to-where-we-started-how-did-we-calibrate-the-default-pre-processed-directories-in-oggm-1-6" title="Link to this heading">#</a></h2>
<p>There are no easy solutions to the problem of overparameterisation. Here we explain the steps taken by OGGM to calibrate the parameters globally for our users who don’t want to care about calibration.</p>
<p>In the <a class="reference external" href="https://cluster.klima.uni-bremen.de/~oggm/gdirs/oggm_v1.6/L3-L5_files/2023.1/">preprocessed directories</a> MB model calibration is done by using <code class="docutils literal notranslate"><span class="pre">mb_calibration_from_geodetic_mb</span></code> to determine the MB model parameters. We will reproduce the option from the preprocessed directory first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span><span class="o">.</span><span class="n">execute_entity_task</span><span class="p">(</span><span class="n">mb_calibration_from_geodetic_mb</span><span class="p">,</span> 
                             <span class="n">gdir_hef</span><span class="p">,</span> 
                             <span class="n">informed_threestep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>   <span class="c1"># &quot;informed_threestep&quot; is what OGGM used for 1.6</span>
                             <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-04-25 13:33:27: oggm.workflow: Execute entity tasks [mb_calibration_from_geodetic_mb] on 1 glaciers
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;rgi_id&#39;: &#39;RGI60-11.00897&#39;,
  &#39;bias&#39;: 0,
  &#39;melt_f&#39;: 5.0,
  &#39;prcp_fac&#39;: 3.532785225968441,
  &#39;temp_bias&#39;: 1.7583130779353044,
  &#39;reference_mb&#39;: -1100.3,
  &#39;reference_mb_err&#39;: 171.8,
  &#39;reference_period&#39;: &#39;2000-01-01_2020-01-01&#39;,
  &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
   &#39;temp_all_solid&#39;: 0.0,
   &#39;temp_all_liq&#39;: 2.0,
   &#39;temp_melt&#39;: -1.0},
  &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}]
</pre></div>
</div>
</div>
</div>
<p>If you want to know more about that function check its docstring:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mb_calibration_from_geodetic_mb?</span>
</pre></div>
</div>
</div>
</div>
<p>Now how did OGGM come to these parameters?</p>
<section id="first-step-data-informed-precipitation-factor">
<h3>First step: data informed precipitation factor<a class="headerlink" href="#first-step-data-informed-precipitation-factor" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> is chosen from a relation to the average winter precipitation. Fig.1 (below) shows the used relationship between winter precipitation and <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>.</p>
<p>It was calibrated by adapting <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> and <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> to match the average geodetic and winter MB on around 100 glaciers with both informations available. The found relationship of decreasing <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> for increasing winter precipitation makes sense, as glaciers with already a large winter precipitation should not be corrected with a large multiplicative <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>.</p>
<div class="alert alert-info">
    <b>
        The precip factor computed this way should be different for any other dataset you may want to use. Computing it in the same way for your dataset is possible (see code availability section in Schuster et al, 2023), but we don't necessarily recommend to follow the same procedure - our confidence in this methodology is limited (to be fair, any methodology to deal with precipitation is limited).  
    </b>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_prcp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
<span class="c1"># we basically do here the same as in massbalance.decide_winter_precip_factor(gdir)</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;winter_prcp_fac_ab&#39;</span><span class="p">]</span>
<span class="n">r0</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;prcp_fac_min&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;prcp_fac_max&#39;</span><span class="p">]</span>
<span class="n">prcp_fac</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">w_prcp_array</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>
<span class="c1"># don&#39;t allow extremely low/high prcp. factors!!!</span>
<span class="n">prcp_fac_array</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clip_array</span><span class="p">(</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w_prcp_array</span><span class="p">,</span> <span class="n">prcp_fac_array</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;winter daily mean precipitation&#39;</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;(kg m$^{-2}$ day$^{-1}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;precipitation factor (prcp_fac)&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fig. 1&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b2473c6afd1548776acf5498eb865d5e4733351245680db181ef6ceff1996f3d.png" src="../../_images/b2473c6afd1548776acf5498eb865d5e4733351245680db181ef6ceff1996f3d.png" />
</div>
</div>
</section>
<section id="second-step-data-informed-temperature-bias">
<h3>Second step: data informed temperature bias<a class="headerlink" href="#second-step-data-informed-temperature-bias" title="Link to this heading">#</a></h3>
<p>Using this data-informed precipitation factor, with then do a global calibration where the temperature bias (<code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>) is calibrated, while the melt factor (<code class="docutils literal notranslate"><span class="pre">melt_f</span></code>) is fixed at 5 kg m-2 day-1 K-1 (default value based on <a class="reference external" href="https://doi.org/10.1017/aog.2023.57">Schuster et al., 2023</a>).</p>
<p>The idea is that if many glaciers within the same grid point need a temperature bias to reach the obeserved MB, this indicates that a systematic correction is necessary (at least for this MB model in particular). In fact, we can plot the median bias required to match MB pbservations using this technique, which gives us the following plot:</p>
<p><img alt="err" src="https://user-images.githubusercontent.com/10050469/224318400-ec1d8825-d7e7-4cdb-94f3-ebb95b8f7120.jpg" /></p>
<p>The fact that the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> parameter is spatially correlated (many regions are all blue or red) indicate that something in the data needs to be corrected for our model. It is this imformation that we use to inform the next step.</p>
<p><strong>The code we used for this step is available <a class="reference external" href="https://cluster.klima.uni-bremen.de/~oggm/gdirs/oggm_v1.6/calibration/1.6.1/">here</a>. As explained above, we do a global run with fixed precip factor and melt factor, then store the resulting parameters in a csv file used by OGGM. The csv file can be found <a class="reference external" href="https://cluster.klima.uni-bremen.de/~oggm/ref_mb_params/oggm_v1.6/w5e5_temp_bias_v2023.4.csv">here</a>.</strong></p>
<div class="alert alert-info">
    <b>
        Similar to the precip factor, we do not necessarily recommend our users to use this method in their own calibration effort. We don't think it's a bad method, but given the importance of calibration we think that diversity is important!
    </b>
</div></section>
<section id="third-step-local-calibration-using-the-data-informed-precipitation-factor-and-temperature-bias-as-first-guesses">
<h3>Third step: local calibration using the data informed precipitation factor and temperature bias as first guesses<a class="headerlink" href="#third-step-local-calibration-using-the-data-informed-precipitation-factor-and-temperature-bias-as-first-guesses" title="Link to this heading">#</a></h3>
<p>Finally, we now run <a class="reference external" href="https://docs.oggm.org/en/latest/generated/oggm.tasks.mb_calibration_from_scalar_mb.html">mb_calibration_from_scalar_mb</a> again for each glacier, as follows:</p>
<ul class="simple">
<li><p>use the first guess: <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> = 5, <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> = data-informed from step 1, <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> = data-informed from step 2</p></li>
<li><p>if this doesn’t match (this would be highly unlikely), allow <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> to vary again between 0.8 and 1.2 times the roiginal guess (<span class="math notranslate nohighlight">\(\pm\)</span>20%). This is justified by the fact that the first guess for precipitation is also highly uncertain. If that worked, the calibration stops (33.6% of all glaciers worldwide are calibrated this way, for 41.1% of the total area).</p></li>
<li><p>if the above did not work, allow <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> to vary again. If that worked, the calibration stops (60.6% of all glaciers worldwide are calibrated this way, for 41.1% of the total area).</p></li>
<li><p>finally, if the above did not work, allow <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> to vary again (5.9% of all glaciers worldwide are calibrated this way, for 2.2% of the total area).</p></li>
</ul>
<div class="alert alert-info">
    <b>
        This informed step-wise calibration is the option that is used operationally in OGGM>=v1.6 in the preprocessed directories (L>=3) for all glaciers world-wide! Note also that if you use the glacier directories with dynamical spinup enabled (our recommendation), then the melt factors are recalibrated once again.
    </b>
</div></section>
<section id="a-look-into-the-global-parameter-distributions">
<h3>A look into the global parameter distributions<a class="headerlink" href="#a-look-into-the-global-parameter-distributions" title="Link to this heading">#</a></h3>
<p>See <a class="reference internal" href="massbalance_global_params.html"><span class="std std-doc">massbalance_global_params.ipynb</span></a></p>
</section>
</section>
<section id="take-home-points">
<h2>Take home points<a class="headerlink" href="#take-home-points" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>We illustrated how a mass-balance (MB) model of a glacier can be calibrated in OGGM.</p></li>
<li><p>We can use different observational data for calibration:</p>
<ul>
<li><p>calibrating to geodetic observations using different time periods, to in-situ direct glaciological observations from the WGMS (if available) or to other custom MB data.</p></li>
</ul>
</li>
<li><p>There exist different ways of calibrating to the average observational data:</p>
<ul>
<li><p>You can use the same option (<code class="docutils literal notranslate"><span class="pre">informed_threestep</span></code>) as done operationally for the <a class="reference external" href="https://cluster.klima.uni-bremen.de/~oggm/gdirs/oggm_v1.6/L3-L5_files/2023.1/elev_bands/W5E5/">preprocessed directories (L&gt;=3)</a> on all glaciers world-wide</p></li>
<li><p>you can calibrate the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, and have the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> fixed. If the calibration does not work, the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> can be varied aswell.</p></li>
<li><p>you can also calibrate instead on <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> or <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> and fix the other parameters.</p></li>
</ul>
</li>
<li><p>However, we showed that the parameter combination choice has an influence on other estimates than the average MB (which then influences also future projections).</p></li>
<li><p>As user of OGGM, you might just use the calibrated MB model parameters from the preprocessed directories. Nevertheless, it is good to be aware of the overparameterisation problem. In addition, if you want to include uncertainties of the MB model calibration, you could include additional experiments that use another calibration option and create your own preprocessed directories with these options. With more available observational data or improved climate data, you might also be able to use better ways to calibrate the MB model parameters.</p></li>
</ul>
</section>
<section id="what-s-next">
<h2>What’s next?<a class="headerlink" href="#what-s-next" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Check out the <a class="reference internal" href="massbalance_global_params.html"><span class="std std-doc">massbalance_global_params.ipynb</span></a> notebook</p></li>
<li><p>return to the <a class="reference external" href="https://docs.oggm.org">OGGM documentation</a></p></li>
<li><p>back to the <a class="reference internal" href="../welcome.html"><span class="std std-doc">table of contents</span></a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/tutorials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../../book/massbalance.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Mass balance</p>
      </div>
    </a>
    <a class="right-next"
       href="plot_mass_balance.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Plotting the OGGM surface mass-balance, the ELA and AAR</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">Set-up</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrated-mass-balance-parameters-in-oggm-v1-6-pre-processed-directories">Calibrated mass balance parameters in OGGM v1.6 pre-processed directories</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-new-flexible-calibration-scheme-in-oggm">The new flexible calibration scheme in OGGM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrate-on-direct-glaciological-in-situ-mb-observations">Calibrate on direct glaciological in-situ MB observations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-errors-and-including-your-own-mass-balance-observations">Dealing with errors and including your own mass-balance observations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overparameteristion-or-the-magic-choice-of-the-best-calibration-option">Overparameteristion or the magic choice of the best calibration option:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#back-to-where-we-started-how-did-we-calibrate-the-default-pre-processed-directories-in-oggm-1-6">Back to where we started: how did we calibrate the default pre-processed directories in OGGM 1.6?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#first-step-data-informed-precipitation-factor">First step: data informed precipitation factor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#second-step-data-informed-temperature-bias">Second step: data informed temperature bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#third-step-local-calibration-using-the-data-informed-precipitation-factor-and-temperature-bias-as-first-guesses">Third step: local calibration using the data informed precipitation factor and temperature bias as first guesses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-look-into-the-global-parameter-distributions">A look into the global parameter distributions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#take-home-points">Take home points</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-s-next">What’s next?</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By OGGM e.V. and OGGM Contributors
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
These notebooks are licensed under a <a href="https://github.com/OGGM/tutorials/blob/master/LICENSE.txt" target="_blank">BSD-3-Clause license</a>.
<br>
&copy; Copyright 2014-2021.
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>