
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>A quick look into different mass-balance calibration options &#8212; OGGM tutorials</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="OGGM flowlines: where are they?" href="where_are_the_flowlines.html" />
    <link rel="prev" title="Compute smoother centerlines for shapefile output" href="centerlines_to_shape.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-106829797-2', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">OGGM tutorials</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../welcome.html">
                    Welcome to the OGGM tutorials!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  10 minutes tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../10minutes/preprocessed_directories.html">
   10 minutes to… a preprocessed directory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../10minutes/run_with_gcm.html">
   10 minutes to… a glacier change projection with GCM data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../10minutes/machine_learning.html">
   10 minutes to… OGGM as an accelerator for modelling and machine learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../10minutes/elevation_bands_vs_centerlines.html">
   10 minutes to… “elevation band” and “centerline” flowlines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../10minutes/dynamical_spinup.html">
   10 minutes to… understand the new dynamical spinup in OGGM v1.6
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Beginner tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../beginner/working_with_rgi.html">
   Working with the RGI files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../beginner/store_and_compress_glacierdirs.html">
   Storing glacier directories for later use
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../beginner/plot_mass_balance.html">
   Plotting the OGGM surface mass-balance, the ELA and AAR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../beginner/deal_with_errors.html">
   Dealing with errors after a run
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../beginner/inversion.html">
   Ice thickness inversion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../beginner/hydrological_output.html">
   Hydrological mass-balance output
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../beginner/oggm_shop.html">
   OGGM-Shop and Glacier Directories in OGGM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../beginner/full_prepro_workflow.html">
   What’s in my preprocessed directories with centerlines? A full OGGM workflow, step by step
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Advanced tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="preprocessing_errors.html">
   Error analysis of the global pre-processing workflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="run_with_a_spinup_and_gcm_data.html">
   Run with a spinup and GCM data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dynamical_spinup.html">
   Dynamic spinup and dynamic
   <span class="math notranslate nohighlight">
    \(\mu^*\)
   </span>
   calibration for past simulations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dem_sources.html">
   Create local topography maps from different DEM sources with OGGM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="use_your_own_inventory.html">
   Using your our own glacier inventory with OGGM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="centerlines_to_shape.html">
   Compute smoother centerlines for shapefile output
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   A quick look into different mass-balance calibration options
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="where_are_the_flowlines.html">
   OGGM flowlines: where are they?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ingest_gridded_data_on_flowlines.html">
   Ingest gridded products such as ice velocity into OGGM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="merge_gcm_runs_and_visualize.html">
   Merge, analyse and visualize OGGM GCM runs
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Related to OGGM
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../others/holoviz_intro.html">
   Small overview of HoloViz capability of data exploration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../others/dem_comparison.html">
   Compare different DEMs for individual glaciers
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  In (re-)construction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../construction/inversion_with_frontal_ablation.html">
   Ice thickness inversion with frontal ablation: a case study
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../construction/kcalving_parameterization.html">
   The Oerlemans &amp; Nick frontal ablation parameterization in OGGM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../construction/merging_glaciers.html">
   Merging glaciers for past climate simulations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../construction/area_length_filter.html">
   Filter the glacier length and area time series
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/OGGM/binder/stable?urlpath=git-pull%3Frepo=https://github.com/OGGM/tutorials%26urlpath%3Dlab%252Ftree%252Ftutorials/./notebooks/advanced/massbalance_calibration.ipynb%26branch%3Dmaster"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://hub.oggm.org/hub/user-redirect/git-pull?repo=https%3A//github.com/OGGM/tutorials&urlpath=lab/tree/tutorials/./notebooks/advanced/massbalance_calibration.ipynb&branch=master"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on JupyterHub"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_jupyterhub.svg">
  </span>
<span class="headerbtn__text-container">JupyterHub</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/OGGM/tutorials"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/OGGM/tutorials/issues/new?title=Issue%20on%20page%20%2Fnotebooks/advanced/massbalance_calibration.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/OGGM/tutorials/edit/master/./notebooks/advanced/massbalance_calibration.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/notebooks/advanced/massbalance_calibration.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up">
   Set-up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#default-mass-balance-calibration-oggm-v1-6-and-variants">
   Default mass-balance calibration (OGGM &gt;=v1.6) and variants
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-calibration-variants">
     Other calibration variants
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calibrate-on-direct-glaciological-in-situ-mb-observations">
   Calibrate on direct glaciological in-situ MB observations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dealing-with-errors-and-including-your-own-mass-balance-observations">
     Dealing with errors and including your own mass-balance observations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overparameteristion-or-the-magic-choice-of-the-best-calibration-option">
   Overparameteristion or the magic choice of the best calibration option:
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#take-home-points">
   Take home points
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-s-next">
   What’s next?
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>A quick look into different mass-balance calibration options</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up">
   Set-up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#default-mass-balance-calibration-oggm-v1-6-and-variants">
   Default mass-balance calibration (OGGM &gt;=v1.6) and variants
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-calibration-variants">
     Other calibration variants
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calibrate-on-direct-glaciological-in-situ-mb-observations">
   Calibrate on direct glaciological in-situ MB observations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dealing-with-errors-and-including-your-own-mass-balance-observations">
     Dealing with errors and including your own mass-balance observations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overparameteristion-or-the-magic-choice-of-the-best-calibration-option">
   Overparameteristion or the magic choice of the best calibration option:
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#take-home-points">
   Take home points
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-s-next">
   What’s next?
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="a-quick-look-into-different-mass-balance-calibration-options">
<h1>A quick look into different mass-balance calibration options<a class="headerlink" href="#a-quick-look-into-different-mass-balance-calibration-options" title="Permalink to this headline">#</a></h1>
<p>The default mass-balance (MB) model of OGGM is a very standard <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0022169403002579">temperature index melt model</a>. At the beginning, OGGM had a complicated calibration procedure where the glaciers with in-situ data were calibrated and then a so-called <em>tstar</em> got interpolated for glaciers without observations (see the <a class="reference external" href="https://www.the-cryosphere.net/6/1295/2012/tc-6-1295-2012.html">original publication</a>). This method was very powerful, however, as new observational datasets emerged, we can finally calibrate on a glacier-per-glacier basis. With the new era of geodetic observations, OGGM uses per default the average geodetic observations from Jan 2000–Jan 2020 of <a class="reference external" href="https://www.nature.com/articles/s41586-021-03436-z">Hugonnet al. 2021</a>, that are now available for almost every glacier world-wide.</p>
<p>In this tutorial, we will:</p>
<ul class="simple">
<li><p><a class="reference external" href="#Default-mass-balance-calibration-(OGGM-%3E=v1.6)-and-variants">introduce the new default calibration procedure and variants</a>)</p></li>
<li><p><a class="reference external" href="#Calibrate-on-direct-glaciological-in-situ-MB-observations">show how to calibrate on glaciers with in-situ observations</a></p></li>
<li><p><a class="reference external" href="#Dealing-with-errors-and-including-your-own-mass-balance-observations">show how to deal with errors and how to calibrate on other data</a></p></li>
<li><p><a class="reference external" href="#Overparameteristion-or-the-magic-choice-of-the-best-calibration-option:">show the influence of different calibration options and explain the overparameterisation problem</a> (more details are e.g. in <a class="reference external" href="https://doi.org/10.31223/X5C65S">Schuster et al., 2023, in review</a>)</p></li>
</ul>
<section id="set-up">
<h2>Set-up<a class="headerlink" href="#set-up" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">oggm</span>
<span class="kn">from</span> <span class="nn">oggm</span> <span class="kn">import</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">graphics</span>
<span class="kn">from</span> <span class="nn">oggm.core</span> <span class="kn">import</span> <span class="n">massbalance</span>
<span class="kn">from</span> <span class="nn">oggm.core.massbalance</span> <span class="kn">import</span> <span class="n">mb_calibration_from_scalar_mb</span><span class="p">,</span> <span class="n">mb_calibration_from_geodetic_mb</span><span class="p">,</span> <span class="n">mb_calibration_from_wgms_mb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">logging_level</span><span class="o">=</span><span class="s1">&#39;WARNING&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">PATHS</span><span class="p">[</span><span class="s1">&#39;working_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(</span><span class="n">dirname</span><span class="o">=</span><span class="s1">&#39;OGGM-calib-mb&#39;</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;border&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-03-10 09:43:23: oggm.cfg: Reading default parameters from the OGGM `params.cfg` configuration file.
2023-03-10 09:43:23: oggm.cfg: Multiprocessing switched OFF according to the parameter file.
2023-03-10 09:43:23: oggm.cfg: Multiprocessing: using all available processors (N=2)
2023-03-10 09:43:23: oggm.cfg: PARAMS[&#39;border&#39;] changed from `80` to `10`.
</pre></div>
</div>
</div>
</div>
<p>We start from two well known glaciers in the Austrian Alps, Kesselwandferner and Hintereisferner. But you can also choose any other other glacier, e.g. from <a class="reference external" href="https://github.com/OGGM/oggm-sample-data/blob/master/wgms/rgi_wgms_links_20220112.csv">this list</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we start from preprocessing level 2</span>
<span class="c1"># in OGGM v1.6 you have to explicitly indicate the url from where you want to start from</span>
<span class="c1"># we will use here the elevation band flowlines which are much simpler than the centerlines</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;https://cluster.klima.uni-bremen.de/~oggm/gdirs/oggm_v1.6/&#39;</span>
            <span class="s1">&#39;L1-L2_files/elev_bands&#39;</span><span class="p">)</span>
<span class="n">gdirs</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">init_glacier_directories</span><span class="p">([</span><span class="s1">&#39;RGI60-11.00787&#39;</span><span class="p">,</span>  <span class="s1">&#39;RGI60-11.00897&#39;</span><span class="p">],</span> <span class="n">from_prepro_level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                          <span class="n">prepro_base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-03-10 09:43:23: oggm.workflow: init_glacier_directories from prepro level 2 on 2 glaciers.
2023-03-10 09:43:23: oggm.workflow: Execute entity tasks [gdir_from_prepro] on 2 glaciers
</pre></div>
</div>
</div>
</div>
<p>We use the preprocessed level 2, so we also need to process the climate ourselves:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the climate that OGGM uses per default:</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;baseline_climate&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;GSWP3_W5E5&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># creates a climate file with the baseline climate, </span>
<span class="c1"># if you want to change the climate, you have to do that,</span>
<span class="c1"># before the calibration!</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">execute_entity_task</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">process_climate_data</span><span class="p">,</span> <span class="n">gdirs</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-03-10 09:43:25: oggm.workflow: Execute entity tasks [process_climate_data] on 2 glaciers
</pre></div>
</div>
</div>
</div>
<p>The two glaciers are neighbors but have very different geometries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">plot_googlemap</span><span class="p">(</span><span class="n">gdirs</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">gdirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rgi_id</span> <span class="o">+</span> <span class="s1">&#39; &amp; &#39;</span> <span class="o">+</span> <span class="n">gdirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/massbalance_calibration_11_0.png" src="../../_images/massbalance_calibration_11_0.png" />
</div>
</div>
</section>
<section id="default-mass-balance-calibration-oggm-v1-6-and-variants">
<h2>Default mass-balance calibration (OGGM &gt;=v1.6) and variants<a class="headerlink" href="#default-mass-balance-calibration-oggm-v1-6-and-variants" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;2000-01-01_2020-01-01&#39;
</pre></div>
</div>
</div>
</div>
<p>Per default the <a class="reference external" href="https://www.nature.com/articles/s41586-021-03436-z">Hugonnet et al. (2021)</a> average geodetic observation is used over the entire time period Jan 2000 to Jan 2020 to calibrate the MB model parameter(s) for every single glacier. Note, that, currently, all calibration options available in OGGM only match a scalar average MB estimate of any kind or length.</p>
<p><strong><code class="docutils literal notranslate"><span class="pre">informed_threestep</span></code> with pre-calibrated gridpoint-dependent temperature bias</strong></p>
<p>In the <a class="reference external" href="https://cluster.klima.uni-bremen.de/~oggm/gdirs/oggm_v1.6/L3-L5_files/2023.1/">preprocessed directories</a>, per default <code class="docutils literal notranslate"><span class="pre">informed_threestep=True</span></code> and MB model calibration is done by using <code class="docutils literal notranslate"><span class="pre">mb_calibration_from_geodetic_mb</span></code> to determine the MB model parameters. We will reproduce the option from the preprocessed directories first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span><span class="o">.</span><span class="n">execute_entity_task</span><span class="p">(</span><span class="n">mb_calibration_from_geodetic_mb</span><span class="p">,</span> <span class="n">gdirs</span><span class="p">,</span> <span class="n">informed_threestep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-03-10 09:43:27: oggm.workflow: Execute entity tasks [mb_calibration_from_geodetic_mb] on 2 glaciers
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;rgi_id&#39;: &#39;RGI60-11.00787&#39;,
  &#39;bias&#39;: 0,
  &#39;melt_f&#39;: 5.0,
  &#39;prcp_fac&#39;: 2.96302677905353,
  &#39;temp_bias&#39;: 1.758147556769245,
  &#39;reference_mb&#39;: -514.8000000000001,
  &#39;reference_mb_err&#39;: 136.3,
  &#39;reference_period&#39;: &#39;2000-01-01_2020-01-01&#39;,
  &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
   &#39;temp_all_solid&#39;: 0.0,
   &#39;temp_all_liq&#39;: 2.0,
   &#39;temp_melt&#39;: -1.0},
  &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;},
 {&#39;rgi_id&#39;: &#39;RGI60-11.00897&#39;,
  &#39;bias&#39;: 0,
  &#39;melt_f&#39;: 5.0,
  &#39;prcp_fac&#39;: 3.5324792824205744,
  &#39;temp_bias&#39;: 1.758147556769245,
  &#39;reference_mb&#39;: -1100.3,
  &#39;reference_mb_err&#39;: 171.8,
  &#39;reference_period&#39;: &#39;2000-01-01_2020-01-01&#39;,
  &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
   &#39;temp_all_solid&#39;: 0.0,
   &#39;temp_all_liq&#39;: 2.0,
   &#39;temp_melt&#39;: -1.0},
  &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># if you want to know more about that function</span>
<span class="c1"># check out the docstring:</span>
<span class="c1"># mb_calibration_from_geodetic_mb?</span>
</pre></div>
</div>
</div>
</div>
<p>The output shows you the calibrated MB model parameters, the used observed reference MB for the calibration (<code class="docutils literal notranslate"><span class="pre">ref_mb</span></code>), the time period and the climate source. Between the two glaciers, only the precipitation factor (<code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>) changed.</p>
<hr class="docutils" />
<p><em><strong>A short excursus to explain the calibration procedure applied for the preprocessed directories:</strong></em></p>
<ul class="simple">
<li><p>First a pre-calibration is done where the temperature bias (<code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>) is calibrated, while the melt factor (<code class="docutils literal notranslate"><span class="pre">melt_f</span></code>) is fixed at 5 kg m-2 day-1 K-1 and <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> is chosen from a relation to the average winter precipitation which is the same for the two neighbouring glaciers (they get their climate from the same climate gridpoint).</p>
<ul>
<li><p>Fig.1a shows the used relationship between winter precipitation and <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>. It was calibrated by adapting <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> and <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> to match the average geodetic and winter MB on around 100 glaciers with both informations available. The found relationship of decreasing <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> for increasing winter precipitation makes sense, as glaciers with already a large winter precipitation should not be corrected with a large multiplicative <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>.</p></li>
</ul>
</li>
<li><p>Then, the median temperature bias for every gridpoint that is used to extract climate data for a glacier is estimated . The distribution of it is shown on Fig. 1b.</p></li>
<li><p>Finally, the actual calibration starts with:</p>
<ul>
<li><p>a <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> of 5 kg m-2 day-1 K-1,</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> as estimated from <code class="docutils literal notranslate"><span class="pre">utils.get_temp_bias_dataframe()['median_temp_bias_w_err_grouped']</span></code> (i.e., different for every gridpoint),</p></li>
<li><p>and a <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> that is in the range of <span class="math notranslate nohighlight">\([0.8,1.2]\times\)</span> <code class="docutils literal notranslate"><span class="pre">prcp_fac</span> <span class="pre">(Fig.</span> <span class="pre">1a)</span></code>.</p></li>
</ul>
</li>
<li><p>If that worked, the calibration stops. Otherwise, the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is changed within a range (and the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>) is at the upper or lower limit of the <span class="math notranslate nohighlight">\([0.8,1.2]\)</span> range. If it still fails, the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> is adapated again.</p></li>
</ul>
<p><strong>This informed step-wise calibration is the option that is used operationally in OGGM&gt;=v1.6 in the preprocessed directories (L&gt;=3) for all glaciers world-wide!</strong>
A detailed explanation of the default calibration will be inside of the OGGM documentation</p>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_prcp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># we basically do here the same as in massbalance.decide_winter_precip_factor(gdir)</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;winter_prcp_fac_ab&#39;</span><span class="p">]</span>
<span class="n">r0</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;prcp_fac_min&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;prcp_fac_max&#39;</span><span class="p">]</span>
<span class="n">prcp_fac</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">w_prcp_array</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>
<span class="c1"># don&#39;t allow extremely low/high prcp. factors!!!</span>
<span class="n">prcp_fac_array</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clip_array</span><span class="p">(</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w_prcp_array</span><span class="p">,</span> <span class="n">prcp_fac_array</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;winter daily mean precipitation&#39;</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;(kg m$^{-2}$ day$^{-1}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;precipitation factor (prcp_fac)&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fig. 1a&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">temp_b_precalib</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_temp_bias_dataframe</span><span class="p">()[</span><span class="s1">&#39;median_temp_bias_w_err_grouped&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">temp_b_precalib</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;temp_bias (°C)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;gridpoint frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fig. 1b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/massbalance_calibration_20_0.png" src="../../_images/massbalance_calibration_20_0.png" />
</div>
</div>
<p>For our two neighboring example glaciers, that share the same climate gridpoint, the same pre-calibrated <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> and the same <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is used. The <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> is slighly different, hence in that example, changing the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> within the narrow range of <span class="math notranslate nohighlight">\([0.8,1.2]\)</span> was sufficient to match the MB model to the observations.</p>
<p>Note that the two glaciers are in the same climate (from the forcing data) but are very different in size, orientation and geometry. So, at least one of the MB model parameters is different (here the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>) and also the observed MB values vary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">gdir</span> <span class="ow">in</span> <span class="n">gdirs</span><span class="p">:</span>
    <span class="n">mbmod</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir</span><span class="p">)</span>
    <span class="n">mean_mb</span> <span class="o">=</span> <span class="n">mbmod</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">fls</span><span class="o">=</span><span class="n">gdir</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;inversion_flowlines&#39;</span><span class="p">),</span>
                                               <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gdir</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;: average MB 2000-2020 = </span><span class="si">{</span><span class="n">mean_mb</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> kg m-2, &#39;</span><span class="p">,</span>
          <span class="sa">f</span><span class="s2">&quot;prcp_fac: </span><span class="si">{</span><span class="n">gdir</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RGI60-11.00787 : average MB 2000-2020 = -514.8 kg m-2,  prcp_fac: 2.96
RGI60-11.00897 : average MB 2000-2020 = -1100.3 kg m-2,  prcp_fac: 3.53
</pre></div>
</div>
</div>
</div>
<p><em>Kesselwandferner has a less negative MB than its neighbor, probably because it is smaller in size and spans less altitude.</em></p>
<p><em>To simplify things, we will now focus just on one glacier (Hintereisferner), but you can repeat it of course with other glaciers:</em></p>
<p>We will change the three MB model parameters (<code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> and <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>) later and see their influence on the calibration.</p>
<p>There are also some global MB parameters (<code class="docutils literal notranslate"><span class="pre">mb_global_params</span></code>), which we assume to be the same globally for every glacier.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_hef</span> <span class="o">=</span> <span class="n">gdirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;mb_global_params&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;temp_default_gradient&#39;: -0.0065,
 &#39;temp_all_solid&#39;: 0.0,
 &#39;temp_all_liq&#39;: 2.0,
 &#39;temp_melt&#39;: -1.0}
</pre></div>
</div>
</div>
</div>
<p>These global MB parameter values were found to represent best the in-situ observations during a cross-validation for glaciers with additional observations. Of course, they could also be changed for different glaciers, but this would need even more data to justify the differences! The influence of using a different temperature lapse rate gradient to the default -0.0065 K/km are analysed in <a class="reference external" href="https://doi.org/10.31223/X5C65S">Schuster et al. (2023, in review)</a>.</p>
<p>Let’s check if the calibration worked:</p>
<ul class="simple">
<li><p>We will get first the average modelled MB,</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">get_inversion_flowline_hw</span><span class="p">()</span>
<span class="n">mb_geod</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="c1"># Note, if you change cfg.PARAMS[&#39;geodetic_mb_period&#39;], you need to change the years here as well!</span>
<span class="n">mbdf</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_geod</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">mbdf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mod_mb   -1100.3
dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>then get the observed geodetic MB that we calibrated our mass-balance to.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reference MB: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;reference_mb&#39;</span><span class="p">])</span><span class="o">+</span> <span class="s1">&#39; kg m-2&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reference MB uncertainties: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;reference_mb_err&#39;</span><span class="p">])</span><span class="o">+</span> <span class="s1">&#39; kg m-2&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reference MB time period: &#39;</span> <span class="o">+</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;reference_period&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>reference MB: -1100.3 kg m-2
reference MB uncertainties: 171.8 kg m-2
reference MB time period: 2000-01-01_2020-01-01
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We calibrated on the entire 20-yr time period, because then the observational uncertainties are smallest.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># this tests if the two parameters are very similar:</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;reference_mb&#39;</span><span class="p">],</span> <span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Perfect! Our MB model reproduces the average observed MB, so the calibrated worked!</p>
<section id="other-calibration-variants">
<h3>Other calibration variants<a class="headerlink" href="#other-calibration-variants" title="Permalink to this headline">#</a></h3>
<p>We have now used the option that is applied in the preprocessed directories. However, there are many other calibration options. We will show you some, but you could also invent your own for your purposes.</p>
<p><strong>Calibrate <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, fixed <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">temp_bìas</span></code></strong></p>
<p>For example, let’s calibrate the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> to match the same observations as before (i.e., average geodetic observation) and fix the other parameters. We will now use the more general function <code class="docutils literal notranslate"><span class="pre">mb_calibration_from_scalar_mb</span></code> as it is more flexible. However, it always needs you to give manually the observed MB on which you want to calibrate:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># if you use the default calibration data from Hugonnet et al., 2021, </span>
<span class="c1"># we can get the geodetic data from any glacier from here:</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_geodetic_mb_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">]</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">ref_mb_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">]]</span>
<span class="c1"># dmdtda: in meters water-equivalent per year -&gt; we convert to kg m-2 yr-1</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;dmdtda&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">ref_mb</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1100.3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s calibrate the melt_f (this is the default option in mb_calibration_from_scalar_mb)</span>
<span class="c1"># overwrite_gdir has to be set to True,</span>
<span class="c1"># because we want to overwrite the old calibration</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span>
                              <span class="n">ref_mb</span> <span class="o">=</span> <span class="n">ref_mb</span><span class="p">,</span> 
                              <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                              <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">mb_melt_f</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_melt_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_melt_f</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s read the new calibrated MB model parameter for the glacier:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rgi_id&#39;: &#39;RGI60-11.00897&#39;,
 &#39;bias&#39;: 0,
 &#39;melt_f&#39;: 9.06088881579363,
 &#39;prcp_fac&#39;: 3.3571363162713674,
 &#39;temp_bias&#39;: 0,
 &#39;reference_mb&#39;: -1100.3,
 &#39;reference_mb_err&#39;: None,
 &#39;reference_period&#39;: &#39;2000-01-01_2020-01-01&#39;,
 &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
  &#39;temp_all_solid&#39;: 0.0,
  &#39;temp_all_liq&#39;: 2.0,
  &#39;temp_melt&#39;: -1.0},
 &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}
</pre></div>
</div>
</div>
</div>
<p>Only the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is used to calibrate the MB model. <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> was chosen depending on the average winter precipitation (see Fig. 1a) and <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> is 0.</p>
<p><strong>Calibrate <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>, fixed <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">melt_f</span></code></strong></p>
<p>We will now instead fix the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> and the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>, and use the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> as free variable for calibration. For that we overwrite the default value of <code class="docutils literal notranslate"><span class="pre">calibrate_param1</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s calibrate on the temp_bias instead</span>
<span class="c1"># overwrite_gdir has to be set to True,</span>
<span class="c1"># because we want to overwrite the old calibration</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span>
                              <span class="n">ref_mb</span> <span class="o">=</span> <span class="n">ref_mb</span><span class="p">,</span> 
                              <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                              <span class="n">calibrate_param1</span><span class="o">=</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">,</span>
                              <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">mb_temp_b</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_temp_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_temp_b</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">],</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">],</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;melt_f&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1.6621867397806114, 3.3571363162713674, 5.0)
</pre></div>
</div>
</div>
</div>
<p>Here we used the median <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> (i.e., 5 kg m-2 day-1 K-1) and the same <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> as in the previous option, but changed <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> until the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> is matched. As the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is lower than in the previous calibration option, we need to have a positive <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> to get to the same average MB (i.e., <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code>).</p>
<p><strong>Calibrate <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>, fixed <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> and <code class="docutils literal notranslate"><span class="pre">melt_f</span></code></strong></p>
<p>We can also just calibrate on the precipitation factor (<code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s calibrate on the prcp_fac instead</span>
<span class="c1"># overwrite_gdir has to be set to True,</span>
<span class="c1"># because we want to overwrite the old calibration</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span>
                              <span class="n">ref_mb</span> <span class="o">=</span> <span class="n">ref_mb</span><span class="p">,</span> 
                              <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                              <span class="n">calibrate_param1</span><span class="o">=</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">,</span>
                              <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">mb_prcp_fac</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_prcp_fac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_prcp_fac</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">],</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">],</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)[</span><span class="s1">&#39;melt_f&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0, 1.0160354839620402, 5.0)
</pre></div>
</div>
</div>
</div>
<p>We chose two glaciers that actually have also in-situ observations available.
We will get the in-situ observations like that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;in_situ_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">get_ref_mb_data</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">][</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">]</span>
<span class="c1"># if we want to compare the average to the average geodetic MB, we need to have all years available</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;in_situ_mb&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot how well we match the interannual observations for the different calibration options:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;in_situ_mb&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;in-situ observations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">in_situ_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span><span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;modelled mass-balance via `informed_threestep`</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">mod_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_melt_f&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;modelled mass-balance via calibrating melt_f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">mod_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_temp_b&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;modelled mass-balance via calibrating temp_bias</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">mod_mb_temp_b</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf</span><span class="p">[</span><span class="s1">&#39;mod_mb_prcp_fac&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;modelled mass-balance via calibrating prcp_fac</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average 2000-2020: </span><span class="si">{</span><span class="n">mbdf</span><span class="o">.</span><span class="n">mod_mb_prcp_fac</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;specific mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/massbalance_calibration_54_0.png" src="../../_images/massbalance_calibration_54_0.png" />
</div>
</div>
<p>For this glacier, over the same time period (here 2000-2020), the average MB is quite similar between the geodetic and in-situ observation and could even be explained by the fact that the in-situ observations are in hydrological years (starting in October of the previous year) and the geodetic observations are in calendar years. If you repeat the analysis for other glaciers with in-situ observations over that time period, you might see larger discrepancies.</p>
<p>You can also see, that there are differences in the annual MB between the calibration options and the in-situ observations. We will analyse these differences more systematically later! Note, that the <code class="docutils literal notranslate"><span class="pre">informed_threestep</span></code> option is for that glacier very similar to the option where the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> is calibrated, however, this is different on other glaciers.</p>
</section>
</section>
<section id="calibrate-on-direct-glaciological-in-situ-mb-observations">
<h2>Calibrate on direct glaciological in-situ MB observations<a class="headerlink" href="#calibrate-on-direct-glaciological-in-situ-mb-observations" title="Permalink to this headline">#</a></h2>
<p>Ok, but actually you might trust the in-situ observations much more than the geodetic observation. So if you are only interested in glaciers with these in-situ observations, you can also use the in-situ observations for calibration. This might allow you also to calibrate over a longer time period and to use additional informations (such as the interannual MB variability, seasonal MB, …). However, bare in mind that there are often gaps in the in-situ MB time series and make sure that you calibrate to the same modelled time period!</p>
<p>Attention: For the Hintereisferner glacier with an almost 70-year long time series, the assumption that we make, i.e., that the area does not change over the time period, gets more problematic. So think twice before repeating this at home!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mb_calibration_from_wgms_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rgi_id&#39;: &#39;RGI60-11.00897&#39;,
 &#39;bias&#39;: 0,
 &#39;melt_f&#39;: 11.27883598160852,
 &#39;prcp_fac&#39;: 3.3571363162713674,
 &#39;temp_bias&#39;: 0,
 &#39;reference_mb&#39;: -648.223880597015,
 &#39;reference_mb_err&#39;: None,
 &#39;reference_period&#39;: &#39;custom&#39;,
 &#39;mb_global_params&#39;: {&#39;temp_default_gradient&#39;: -0.0065,
  &#39;temp_all_solid&#39;: 0.0,
  &#39;temp_all_liq&#39;: 2.0,
  &#39;temp_melt&#39;: -1.0},
 &#39;baseline_climate_source&#39;: &#39;GSWP3_W5E5&#39;}
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mb_calibration_from_wgms_mb</span></code> is a short-cut function that uses internally <code class="docutils literal notranslate"><span class="pre">mb_calibration_from_scalar_mb</span></code>,
but applies directly the average annual in-situ MB observations from the WGMS. Per default, the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is calibrated, and <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> are fixed. You can get the observations like that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbdf_in_situ</span> <span class="o">=</span> <span class="n">gdir_hef</span><span class="o">.</span><span class="n">get_ref_mb_data</span><span class="p">()</span>
<span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;ref_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">]</span>
<span class="c1"># check that every year between the beginning and the end has MB observations </span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">ref_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mb_in_situ_obs</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_in_situ_obs</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;ref_mb&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;in-situ observations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average: </span><span class="si">{</span><span class="n">ref_mb</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span><span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="p">[</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">],</span>
         <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;modelled mass-balance</span><span class="se">\n</span><span class="s1">via calibrating melt_f</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="o">+</span><span class="sa">f</span><span class="s1">&#39;average: </span><span class="si">{</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">mod_mb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;kg m$^{-2}$&#39;</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;specific mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/massbalance_calibration_61_0.png" src="../../_images/massbalance_calibration_61_0.png" />
</div>
</div>
<p>The average MB over the entire time period is matched as we calibrate to it. However, the interannual mass-balance variability is different. How well the modelled annual mass-balance time series matches the observations can be for example assessed by looking at the correlation between modelled and observed annual MB</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbdf_in_situ</span><span class="p">[[</span><span class="s1">&#39;ref_mb&#39;</span><span class="p">,</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.806883065989496
</pre></div>
</div>
</div>
</div>
<p>or by looking into the standard deviation of interannual MB variability, where we see a much larger variability for the modelled MB:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">std</span><span class="p">()[[</span><span class="s1">&#39;ref_mb&#39;</span><span class="p">,</span><span class="s1">&#39;mod_mb&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_5947/3039749986.py:1: FutureWarning: The default value of numeric_only in DataFrame.std is deprecated. In a future version, it will default to False. In addition, specifying &#39;numeric_only=None&#39; is deprecated. Select only valid columns or specify the value of numeric_only to silence this warning.
  mbdf_in_situ.std()[[&#39;ref_mb&#39;,&#39;mod_mb&#39;]]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ref_mb     624.538759
mod_mb    1276.246655
dtype: float64
</pre></div>
</div>
</div>
</div>
<section id="dealing-with-errors-and-including-your-own-mass-balance-observations">
<h3>Dealing with errors and including your own mass-balance observations<a class="headerlink" href="#dealing-with-errors-and-including-your-own-mass-balance-observations" title="Permalink to this headline">#</a></h3>
<p>Let’s look at another glacier, now in Central Asia, for example the Golubin glacier:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdir_2</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">init_glacier_directories</span><span class="p">([</span><span class="s1">&#39;RGI60-13.11609&#39;</span><span class="p">],</span> <span class="n">from_prepro_level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                         <span class="n">prepro_base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">tasks</span><span class="o">.</span><span class="n">process_climate_data</span><span class="p">(</span><span class="n">gdir_2</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">graphics</span><span class="o">.</span><span class="n">plot_googlemap</span><span class="p">([</span><span class="n">gdir_2</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-03-10 09:43:30: oggm.workflow: init_glacier_directories from prepro level 2 on 1 glaciers.
2023-03-10 09:43:30: oggm.workflow: Execute entity tasks [gdir_from_prepro] on 1 glaciers
</pre></div>
</div>
<img alt="../../_images/massbalance_calibration_69_2.png" src="../../_images/massbalance_calibration_69_2.png" />
</div>
</div>
<p>Let’s calibrate that glacier by only changing the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, default in <code class="docutils literal notranslate"><span class="pre">mb_calibration_from_scalar_mb</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first need to get the MB observations again</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_geodetic_mb_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdir_2</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">]</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">ref_mb_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">]]</span>
<span class="c1"># dmdtda: in meters water-equivalent per year -&gt; we convert to kg m-2 yr-1</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;dmdtda&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">ref_mb</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-255.9
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_2</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">ref_period</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">])</span>
<span class="c1"># you could also calibrate on the WGMS data instead</span>
<span class="c1"># as this glacier has in-situ MB observations</span>
<span class="c1"># mb_calibration_from_wgms_mb(gdir_2, overwrite_gdir=True)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-03-10 09:43:32: oggm.core.massbalance: RuntimeError occurred during task mb_calibration_from_scalar_mb on RGI60-13.11609: RGI60-13.11609: ref mb not matched. Try to set calibrate_param2.
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="nn">File /usr/local/pyenv/versions/3.10.10/lib/python3.10/site-packages/oggm/core/massbalance.py:1778,</span> in <span class="ni">mb_calibration_from_scalar_mb</span><span class="nt">(gdir, ref_mb, ref_mb_err, ref_period, ref_mb_years, write_to_gdir, overwrite_gdir, calibrate_param1, calibrate_param2, calibrate_param3, melt_f, melt_f_min, melt_f_max, prcp_fac, prcp_fac_min, prcp_fac_max, temp_bias, temp_bias_min, temp_bias_max, mb_model_class)</span>
<span class="g g-Whitespace">   </span><span class="mi">1777</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1778</span>     <span class="n">optim_param1</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">to_minimize</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1779</span>                                    <span class="n">min_range</span><span class="p">,</span> <span class="n">max_range</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1780</span>                                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">calibrate_param1</span><span class="p">,)</span>
<span class="g g-Whitespace">   </span><span class="mi">1781</span>                                    <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1782</span> <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

<span class="nn">File /usr/local/pyenv/versions/3.10.10/lib/python3.10/site-packages/scipy/optimize/_zeros_py.py:783,</span> in <span class="ni">brentq</span><span class="nt">(f, a, b, args, xtol, rtol, maxiter, full_output, disp)</span>
<span class="g g-Whitespace">    </span><span class="mi">782</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rtol too small (</span><span class="si">%g</span><span class="s2"> &lt; </span><span class="si">%g</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rtol</span><span class="p">,</span> <span class="n">_rtol</span><span class="p">))</span>
<span class="ne">--&gt; </span><span class="mi">783</span> <span class="n">r</span> <span class="o">=</span> <span class="n">_zeros</span><span class="o">.</span><span class="n">_brentq</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">xtol</span><span class="p">,</span> <span class="n">rtol</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">full_output</span><span class="p">,</span> <span class="n">disp</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">784</span> <span class="k">return</span> <span class="n">results_c</span><span class="p">(</span><span class="n">full_output</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

<span class="ne">ValueError</span>: f(a) and f(b) must have different signs

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">RuntimeError</span><span class="g g-Whitespace">                              </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_2</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">ref_period</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="c1"># you could also calibrate on the WGMS data instead</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1"># as this glacier has in-situ MB observations</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="c1"># mb_calibration_from_wgms_mb(gdir_2, overwrite_gdir=True)</span>

<span class="nn">File /usr/local/pyenv/versions/3.10.10/lib/python3.10/site-packages/oggm/utils/_workflow.py:491,</span> in <span class="ni">entity_task.__call__.&lt;locals&gt;._entity_task</span><span class="nt">(gdir, reset, print_log, return_value, continue_on_error, add_to_log_file, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">489</span>     <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;task_timeout&#39;</span><span class="p">])</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="n">ex_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">out</span> <span class="o">=</span> <span class="n">task_func</span><span class="p">(</span><span class="n">gdir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">492</span> <span class="n">ex_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ex_t</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;task_timeout&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

<span class="nn">File /usr/local/pyenv/versions/3.10.10/lib/python3.10/site-packages/oggm/core/massbalance.py:1784,</span> in <span class="ni">mb_calibration_from_scalar_mb</span><span class="nt">(gdir, ref_mb, ref_mb_err, ref_period, ref_mb_years, write_to_gdir, overwrite_gdir, calibrate_param1, calibrate_param2, calibrate_param3, melt_f, melt_f_min, melt_f_max, prcp_fac, prcp_fac_min, prcp_fac_max, temp_bias, temp_bias_min, temp_bias_max, mb_model_class)</span>
<span class="g g-Whitespace">   </span><span class="mi">1782</span> <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1783</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">calibrate_param2</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1784</span>         <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">gdir</span><span class="o">.</span><span class="n">rgi_id</span><span class="si">}</span><span class="s1">: ref mb not matched. &#39;</span>
<span class="g g-Whitespace">   </span><span class="mi">1785</span>                            <span class="sa">f</span><span class="s1">&#39;Try to set calibrate_param2.&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1787</span>     <span class="c1"># Check which direction we need to go</span>
<span class="g g-Whitespace">   </span><span class="mi">1788</span>     <span class="n">diff_1</span> <span class="o">=</span> <span class="n">to_minimize</span><span class="p">(</span><span class="n">min_range</span><span class="p">,</span> <span class="n">calibrate_param1</span><span class="p">)</span>

<span class="ne">RuntimeError</span>: RGI60-13.11609: ref mb not matched. Try to set calibrate_param2.
</pre></div>
</div>
</div>
</div>
<p>We got a <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> that says that the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> is not matched and that we should set <code class="docutils literal notranslate"><span class="pre">calibrate_param2</span></code>. What happened?</p>
<p>Well, no <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> parameter could be found in the given ranges to reproduce the given calibration data (<code class="docutils literal notranslate"><span class="pre">ref_mb</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># What are the current minimum and maximum ranges of the melt factor (unit: kg m-2 day-1 K-1)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;melt_f_min&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;melt_f_max&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>If we believe that our observations are true, maybe the climate or the processes represented by the MB model are erroneous.</p>
<p>What can we do to still match the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code>? We can either change the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> ranges by setting other values to the parameters above or we can allow that another MB model parameter is changed (i.e., <code class="docutils literal notranslate"><span class="pre">calibrate_param2</span></code>). This is basically very similar to the three-step-calibration
first introduced in <a class="reference external" href="https://doi.org/10.3389/feart.2015.00054">Huss &amp; Hock 2015</a> or in the new <code class="docutils literal notranslate"><span class="pre">informed_threestep</span></code> option for the preprocessed directories in OGGM&gt;=v1.6, but here you can choose your parameter ranges and parameter order yourself.</p>
<p>To reduce these MB model calibration errors, you can first change the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, fix it at the lower or upper limit, and then change the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allowing another parameter to change is done by defining calibrate_param2</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_2</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">ref_period</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span> 
                              <span class="n">calibrate_param2</span><span class="o">=</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is at the minimum value and temperature was corrected to more negative values to allow for the relatively weak negative MB.</p>
<p><strong>Use your own or fake MB observations for calibration</strong></p>
<p>In the same way, you can also use your own MB observations or fake data to calibrate the MB model. We use here as an example, an unrealistically high positive MB for the Hintereisferner over a 10-year time period. To allow the calibration to happen, we need again to set <code class="docutils literal notranslate"><span class="pre">calibrate_param2</span></code>! Here we will use the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> as second parameter for a change:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_period</span> <span class="o">=</span> <span class="s1">&#39;2000-01-01_2010-01-01&#39;</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># Let&#39;s use an unrealistically positive  mass-balance</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span>
                                <span class="n">ref_period</span><span class="o">=</span><span class="n">ref_period</span><span class="p">,</span> <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                               <span class="n">calibrate_param2</span><span class="o">=</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mb_new</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
<span class="c1"># ok, we actually matched the new ref_mb over the 10-yr period</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">ref_mb</span><span class="p">,</span>
                           <span class="n">mb_new</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2010</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="c1"># Let&#39;s look at the calibrated parameters</span>
<span class="n">gdir_hef</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;mb_calib&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Ok, in that case, the climate was too warm to allow for such a positive MB. Even the smallest <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> did not allow for such a positive MB. Therefore, the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> was increased to allow that more (solid) precipitation can occur.</p>
<p>However, also the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> has a limited range:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;prcp_fac_min&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;prcp_fac_max&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>So, if we increase the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> even further, we might even need a third free parameter (i.e., we need to set <code class="docutils literal notranslate"><span class="pre">calibrate_param3</span></code>).
Let’s try it out, by using now the same order as in <a class="reference external" href="https://doi.org/10.3389/feart.2015.00054">Huss &amp; Hock (2015)</a> (but different allowed parameter changes that also depend on the chosen climate…):</p>
<p>That means, we match the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> by</p>
<ul class="simple">
<li><p>first trying to adapt <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>,</p></li>
<li><p>then <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>,</p></li>
<li><p>and finally <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_mb</span> <span class="o">=</span> <span class="mi">6000</span> <span class="c1"># if you replace it with 8000, no combination of parameters can be found for that glacier</span>
<span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span><span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span>
                              <span class="n">ref_period</span><span class="o">=</span><span class="n">ref_period</span><span class="p">,</span>
                              <span class="n">calibrate_param1</span><span class="o">=</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">,</span>
                              <span class="n">calibrate_param2</span><span class="o">=</span><span class="s1">&#39;melt_f&#39;</span><span class="p">,</span>
                              <span class="n">calibrate_param3</span><span class="o">=</span><span class="s1">&#39;temp_bias&#39;</span><span class="p">,</span>
                              <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In that case, the minimum <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> and the maximum <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> are applied. The <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> is set to a negative value as this results in more solid precipitation. If you increased the <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> even further, the method will not find any combination as the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> also has a limited
range. If you really want to match the observation, then you would need to change the parameter ranges.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;temp_bias_min&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;temp_bias_max&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### check out the docstring for more information about the options</span>
<span class="c1">### by uncommenting the line below:</span>
<span class="c1"># mb_calibration_from_scalar_mb?</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="overparameteristion-or-the-magic-choice-of-the-best-calibration-option">
<h2>Overparameteristion or the magic choice of the best calibration option:<a class="headerlink" href="#overparameteristion-or-the-magic-choice-of-the-best-calibration-option" title="Permalink to this headline">#</a></h2>
<p>We found already some combinations that equally well match the average MB over a given time period. As we only use only one observation per glacier (i.e., per default the average geodetic MB from 2000-2020), but have up to three free MB model parameters, the MB model is overparameterised. That means, there are in theory an infinite amount of calibration options possible that equally well match the one obervation. Let’s look a bit more systematically into that:</p>
<p>We will use a range of different <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and then calibrate the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> accordingly to always match to the default average MB (<code class="docutils literal notranslate"><span class="pre">ref_mb</span></code>) over the reference period (<code class="docutils literal notranslate"><span class="pre">ref_period</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s go back to the Hintereisferner glacier and get again the MB observations:</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_geodetic_mb_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">]</span>
<span class="n">ref_mb_df</span> <span class="o">=</span> <span class="n">ref_mb_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">]]</span>
<span class="n">ref_mb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_mb_df</span><span class="p">[</span><span class="s1">&#39;dmdtda&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calibrate the melt_f and annual MB </span>
<span class="n">pd_prcp_fac_sens</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">))</span>
<span class="n">spec_mb_prcp_fac_sens_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">prcp_fac</span> <span class="ow">in</span> <span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">calib_param</span> <span class="o">=</span> <span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                                                <span class="n">prcp_fac</span><span class="o">=</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="s1">&#39;melt_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calib_param</span><span class="p">[</span><span class="s1">&#39;melt_f&#39;</span><span class="p">]</span>
    <span class="n">mb_prcp_fac_sens</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
    <span class="c1"># ok, we actually matched the new ref_mb</span>
    <span class="n">annual_mb</span> <span class="o">=</span> <span class="n">mb_prcp_fac_sens</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">spec_mb_prcp_fac_sens_dict</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">]</span> <span class="o">=</span> <span class="n">annual_mb</span>
    <span class="c1"># let&#39;s also check how well the interannual MB variability is matched</span>
    <span class="c1"># by comparing the standard deviation of the annual MB to the observed one</span>
    <span class="n">std_quot_annual_mb</span> <span class="o">=</span> <span class="n">annual_mb</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">,</span> <span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="s1">&#39;std_quot_annual_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_quot_annual_mb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s get some nice colors visualising more precipitation</span>
<span class="n">colors_prcp_fac</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis_r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">10</span><span class="p">::</span><span class="mi">10</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">prcp_fac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">,</span> <span class="s1">&#39;melt_f&#39;</span><span class="p">],</span>
             <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors_prcp_fac</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;melt_f (kg m$^{-2}$ day$^{-1}$ K$^{-1}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>All these combinations match the average <code class="docutils literal notranslate"><span class="pre">ref_mb</span></code> equally. The larger the chosen <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>, the larger needs to be the calibrated <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> when matching to the same average MB.</p>
<p>What is the influence on the chosen parameter combination on other estimates than the average MB?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">prcp_fac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pd_prcp_fac_sens</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
             <span class="n">spec_mb_prcp_fac_sens_dict</span><span class="p">[</span><span class="n">prcp_fac</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="n">colors_prcp_fac</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prcp_fac</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
         <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">][</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">],</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed in-situ&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Annual mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;prcp_fac:&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>The larger the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, the larger is the interannual MB variability. For glaciers with in-situ observations, we can find a combination of <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> that has a similar interannnual MB variability than the observations. For example, you can choose a MB model parameter combination where the standard deviation quotient of the annual the modelled and observed MB is near to 1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condi</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_prcp_fac_sens</span><span class="p">[</span><span class="s1">&#39;std_quot_annual_mb&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pd_prcp_fac_sens</span><span class="p">[</span><span class="s1">&#39;std_quot_annual_mb&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">pd_prcp_fac_sens</span><span class="p">[</span><span class="n">condi</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>For the Hintereisferner glacier, the best MB model combination to match the interannual MB variability would be for a <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> between 1.6 and 1.9 and a <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> between 6 and 6.5 (more in <a class="reference external" href="https://doi.org/10.31223/X5C65S">Schuster et al., 2023, in review</a>).</p>
<p><strong>We can also fix the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code>, and change the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> and <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> instead:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">melt_f_dict_tb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">spec_mb_temp_b_sens_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">temp_bias</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="c1"># for too negative temp_bias, no melt_f is found that matches the observations. We would need to </span>
    <span class="c1"># change the prcp_fac , but here we will just look</span>
    <span class="c1"># at those combinations where calibration works with a fixed prcp_fac. </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">calib_param</span> <span class="o">=</span> <span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                                                    <span class="n">temp_bias</span><span class="o">=</span><span class="n">temp_bias</span><span class="p">,</span> <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">melt_f_dict_tb</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">]</span> <span class="o">=</span> <span class="n">calib_param</span><span class="p">[</span><span class="s1">&#39;melt_f&#39;</span><span class="p">]</span>
        <span class="n">mb_temp_b_sens</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
        <span class="c1"># ok, we actually matched the new ref_mb</span>
        <span class="n">spec_mb_temp_b_sens_dict</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_temp_b_sens</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span> <span class="c1">#, &#39;RGI60-11.00897: ref mb not matched. Try to set calibrate_param2&#39;</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s get a nice colormap centered at temp_bias=0</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">5.01</span><span class="p">)</span>
<span class="n">colors_temp_bias</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">temp_bias</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">melt_f_dict_tb</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">,</span> <span class="n">melt_f_dict_tb</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="n">colors_temp_bias</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">)))</span> 
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;melt_f (kg m$^{-2}$ day$^{-1}$ K$^{-1}$)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;temp_bias (°C)&#39;</span><span class="p">);</span>


<span class="k">for</span> <span class="n">temp_bias</span> <span class="ow">in</span> <span class="n">melt_f_dict_tb</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
             <span class="n">spec_mb_temp_b_sens_dict</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="n">colors_temp_bias</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">)),</span>
             <span class="n">label</span><span class="o">=</span><span class="n">temp_bias</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">][</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed in-situ&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Annual mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;temp_bias:&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>A lower <code class="docutils literal notranslate"><span class="pre">melt_f</span></code> is needed if a positive <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> is applied… and with that the interannual MB variability gets smaller.</p>
<p><strong>Or we change <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code>, and fix the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code></strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pf_temp_b_dict_tb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">spec_mb_pf_temp_b_sens_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">temp_bias</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="c1"># for too negative temp_bias, no prcp_fac is found that matches the observations. We would need to </span>
    <span class="c1"># change the melt_f , but here we will just look</span>
    <span class="c1"># at those combinations where calibration works with a fixed melt_f. </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">calib_param</span> <span class="o">=</span> <span class="n">mb_calibration_from_scalar_mb</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">,</span> <span class="n">calibrate_param1</span><span class="o">=</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">,</span>
                                                    <span class="n">ref_mb</span><span class="o">=</span><span class="n">ref_mb</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;geodetic_mb_period&#39;</span><span class="p">],</span>
                                                    <span class="n">temp_bias</span><span class="o">=</span><span class="n">temp_bias</span><span class="p">,</span> <span class="n">overwrite_gdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pf_temp_b_dict_tb</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">]</span> <span class="o">=</span> <span class="n">calib_param</span><span class="p">[</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">]</span>
        <span class="n">mb_pf_temp_b_sens</span> <span class="o">=</span> <span class="n">massbalance</span><span class="o">.</span><span class="n">MonthlyTIModel</span><span class="p">(</span><span class="n">gdir_hef</span><span class="p">)</span>
        <span class="c1"># ok, we actually matched the new ref_mb</span>
        <span class="n">spec_mb_pf_temp_b_sens_dict</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb_pf_temp_b_sens</span><span class="o">.</span><span class="n">get_specific_mb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span> <span class="c1">#, &#39;RGI60-11.00897: ref mb not matched. Try to set calibrate_param2&#39;</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s get another centered colormap at temp_bias=0</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">5.01</span><span class="p">)</span>
<span class="n">colors_temp_bias</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Spectral_r&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">temp_bias</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pf_temp_b_dict_tb</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">,</span> <span class="n">pf_temp_b_dict_tb</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="n">colors_temp_bias</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">)))</span> 
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;prcp_fac&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;temp_bias (°C)&#39;</span><span class="p">);</span>


<span class="k">for</span> <span class="n">temp_bias</span> <span class="ow">in</span> <span class="n">pf_temp_b_dict_tb</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
             <span class="n">spec_mb_pf_temp_b_sens_dict</span><span class="p">[</span><span class="n">temp_bias</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="n">colors_temp_bias</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">temp_bias</span><span class="p">)),</span>
             <span class="n">label</span><span class="o">=</span><span class="n">temp_bias</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mbdf_in_situ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">2019</span><span class="p">][</span><span class="s1">&#39;ANNUAL_BALANCE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed in-situ&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Annual mass-balance (kg m$^{-2}$)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;temp_bias:&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">gdir_hef</span><span class="o">.</span><span class="n">rgi_id</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>A larger <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> needs a larger <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> … and with that the interannual MB variability gets larger.</p>
<p>The parameter combination choice or calibration option also influences the modelled seasonal MB or elevation-dependent MB over the calibration period. Additionally, volume and runoff are influenced by the model parameter choice. If you are further interested in that, you can have a look into <a class="reference external" href="https://doi.org/10.31223/X5C65S">Schuster et al (2023, in review)</a>, which analyses the “Glacier projections sensitivity to temperature-index model choices and calibration strategies”.</p>
<p>Using prior knowledge on the MB model parameters by a Bayesian calibration scheme is a good option to constrain the parameter ranges. Like that you can also directly include the MB observation uncertainties and quantify the parameter uncertainties. You can read about that in <a class="reference external" href="https://doi.org/10.1017/jog.2019.91">Rounce et al., 2020</a>! We are working on including a Bayesian calibration framework into OGGM by using the <code class="docutils literal notranslate"><span class="pre">informed_threestep</span></code> calibration procedure as prior estimates.</p>
</section>
<section id="take-home-points">
<h2>Take home points<a class="headerlink" href="#take-home-points" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>We illustrated how a mass-balance (MB) model of a glacier can be calibrated in OGGM.</p></li>
<li><p>We can use different observational data for calibration:</p>
<ul>
<li><p>calibrating to geodetic observations using different time periods, to in-situ direct glaciological observations from the WGMS (if available) or to other custom MB data.</p></li>
</ul>
</li>
<li><p>There exist different ways of calibrating to the average observational data:</p>
<ul>
<li><p>You can use the same option (<code class="docutils literal notranslate"><span class="pre">informed_threestep</span></code>) as done operationally for the <a class="reference external" href="https://cluster.klima.uni-bremen.de/~oggm/gdirs/oggm_v1.6/L3-L5_files/2023.1/elev_bands/W5E5/">preprocessed directories (L&gt;=3)</a> on all glaciers world-wide</p></li>
<li><p>you can calibrate the <code class="docutils literal notranslate"><span class="pre">melt_f</span></code>, and have the <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> and <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> fixed. If the calibration does not work, the <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> can be varied aswell.</p></li>
<li><p>you can also calibrate instead on <code class="docutils literal notranslate"><span class="pre">prcp_fac</span></code> or <code class="docutils literal notranslate"><span class="pre">temp_bias</span></code> and fix the other parameters.</p></li>
</ul>
</li>
<li><p>However, we showed that the parameter combination choice has an influence on other estimates than the average MB (which then influences also future projections).</p></li>
<li><p>As user of OGGM, you might just use the calibrated MB model parameters from the preprocessed directories. Nevertheless, it is good to be aware of the overparameterisation problem. In addition, if you want to include uncertainties of the MB model calibration, you could include additional experiments that use another calibration option and create your own preprocessed directories with these options. With more available observational data or improved climate data, you might also be able to use better ways to calibrate the MB model parameters.</p></li>
</ul>
</section>
<section id="what-s-next">
<h2>What’s next?<a class="headerlink" href="#what-s-next" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>return to the <a class="reference external" href="https://docs.oggm.org">OGGM documentation</a></p></li>
<li><p>back to the <a class="reference internal" href="../welcome.html"><span class="doc std std-doc">table of contents</span></a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/advanced"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="centerlines_to_shape.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Compute smoother centerlines for shapefile output</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="where_are_the_flowlines.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">OGGM flowlines: where are they?</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By OGGM e.V. and OGGM Contributors<br/>
  
    <div class="extra_footer">
      <p>
These notebooks are licensed under a <a href="https://github.com/OGGM/tutorials/blob/master/LICENSE.txt" target="_blank">BSD-3-Clause license</a>.
<br>
&copy; Copyright 2014-2021.
</p>

    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>